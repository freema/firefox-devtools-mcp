# Code Review – 28 Snapshot bundling integration & de-dup

Datum: 2025-10-15

## Co bylo provedeno

### Eliminace duplikace snapshot kódu
- **Odstraněn obrovský inline script** (300+ řádků) z `SnapshotManager.buildInlineScript()`
- **Jediný zdroj pravdy** – `src/firefox/snapshot/injected/*` je nyní jediným místem kde žije snapshot logika
- Odstraněna duplicita mezi inline verzi a modularizovanou verzi

### Konfigurace bundleru
- **Rozšířen `tsup.config.ts`** pro multi-entry build:
  - `src/index.ts` → `dist/index.js` (ESM, Node.js MCP server)
  - `src/firefox/snapshot/injected/snapshot.injected.ts` → `dist/snapshot.injected.global.js` (IIFE, browser context)
- **IIFE format** s `globalName: '__SnapshotInjected'` pro browser injection
- **Minifikace** zapnuta pro injected bundle (5.54 KB minified)
- **Target: es2020** pro moderní browser compatibility

### Vytvoření UidResolver modulu
- **Nový soubor `src/firefox/snapshot/resolver.ts`**:
  - Vyčleněna logika pro UID validation, resolution, caching
  - 160 řádků čisté separace concerns
  - Metody:
    - `validateUid(uid)` – staleness check
    - `resolveUidToSelector(uid)` – UID → CSS selector
    - `resolveUidToElement(uid)` – UID → WebElement (s cachingem)
    - `storeUidMappings(uidMap)` – ukládání mappingů ze snapshotu
    - `clear()` – invalidace při navigaci

### Refaktor SnapshotManager
- **Štíhlý SnapshotManager** (157 řádků vs. původní 544 řádků = **-71%**)
- **Lazy loading** bundlovaného injected scriptu:
  - Načtení z `dist/snapshot.injected.global.js` při prvním použití
  - Fallback paths pro různá prostředí (development, production)
  - Jasná error message pokud bundle chybí: "Make sure you have run 'npm run build'"
- **Delegace na UidResolver** pro všechny UID operace
- **Odstranění buildInlineScript()** – již není potřeba

### Dotčené soubory
- `tsup.config.ts` – přidán druhý entry point pro injected bundle
- `src/firefox/snapshot/manager.ts` – kompletní refaktor (544 → 157 řádků)
- `src/firefox/snapshot/resolver.ts` (nový) – UID resolution logika
- `src/firefox/snapshot/injected/*` – beze změny (již byli source of truth)

## Rozhodnutí a dopady

### Architektonická rozhodnutí

1. **IIFE bundle format**
   - Používá `globalName: '__SnapshotInjected'` místo přímého `window.__createSnapshot`
   - Umožňuje lepší scope isolation a testovatelnost
   - Bundle registruje funkci při injekci: `window.__createSnapshot = __SnapshotInjected.createSnapshot`

2. **Lazy loading bundlu**
   - Bundle se načítá až při prvním `takeSnapshot()` volání
   - Cachuje se v paměti pro další použití
   - Redukuje startup overhead

3. **Separation of concerns**
   - `SnapshotManager` – orchestrace, bundling, snapshot creation
   - `UidResolver` – UID validation, mapping, element resolution
   - `injected/*` – browser-side snapshot collection logika
   - `formatter.ts` – text formátování

4. **Build-time bundling**
   - Injected script je bundlován při `npm run build`
   - Runtime neobsahuje bundler dependency
   - Produkční bundle je minifikovaný (5.54 KB)

### Známá omezení

- **Build requirement** – Pokud někdo spustí MCP server bez `npm run build`, snapshot funkce selže s jasnou chybou
- **Bundle path resolution** – Používá `process.cwd()` + relative path, což může být fragile v některých edge cases (ale pokrývá běžné scénáře)
- **No source maps** pro injected bundle – debug browser-side kódu je složitější (ale kód je stabilní)

### Metriky

- **Redukce kódu v SnapshotManager**: 544 → 157 řádků (**-71%**)
- **Eliminace duplikace**: ~300 řádků inline JS kódu odstraněno
- **Bundle size**: 5.54 KB minified (IIFE)
- **Build time**: +9ms pro injected bundle (zanedbatelné)

## Testování

### Snapshot testy (offline)
```bash
node scripts/test-bidi-devtools.js
✅ Snapshot taken! (ID: 1)
✅ UID resolution works
✅ Staleness detection works
✅ Iframe support works
```

### Všechny testy prošly
```bash
task check
✅ ESLint: pass
✅ TypeScript: pass
✅ Build: success (2 bundles)

npm run build
✅ dist/index.js (565.38 KB)
✅ dist/snapshot.injected.global.js (5.54 KB)
```

## Reference

- Specifikace úkolu: `tasks/28-snapshot-bundling-integration-and-dedup.md`
- Původní inline implementace: `src/firefox/snapshot/manager.ts` (řádky 236-543, nyní odstraněno)
- Modularizovaný snapshot kód: `src/firefox/snapshot/injected/*`
- Bundler konfigurace: Best practices z tsup documentation

## Další kroky

### Kompletní roadmapa dokončena
- ✅ Tasks 00-28 dokončeny
- ✅ Všechny akceptační kritéria splněna
- ✅ Testy procházejí

### Potenciální vylepšení (volitelné)
- Source maps pro injected bundle (pro easier debugging)
- Embed bundle přímo do `dist/index.js` místo separátního souboru (eliminuje file I/O)
- Cache warming při `FirefoxClient.connect()` (pre-load bundle)
- Compression pro bundle (gzip, ale většinou není potřeba pro 5KB)

## Poznámky

- Snapshot bundling integration eliminovala duplicitní kód a učinila `src/firefox/snapshot/injected/*` jediným zdrojem pravdy
- UidResolver separace zjednodušila SnapshotManager a zlepšila testovatelnost
- Build proces nyní generuje 2 bundles: MCP server (Node.js) + injected script (browser)
- Všechny testy procházejí včetně snapshot staleness detection a iframe support
- **Zero breaking changes** – veřejné API zůstalo stejné, změny jsou internal only

## Závěr

Task 28 úspěšně dokončil modularizaci snapshot systému, eliminoval duplicitní kód (~300 řádků) a zavedl čistou separaci mezi Node.js a browser-side kódem. SnapshotManager je nyní štíhlý (157 řádků), UidResolver je samostatný modul (160 řádků), a injected kód je bundlován do minifikovaného IIFE (5.54 KB).

**Roadmapa 00-28 je kompletně hotová! 🎉**

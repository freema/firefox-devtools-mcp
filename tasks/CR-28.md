# Code Review â€“ 28 Snapshot bundling integration & de-dup

Datum: 2025-10-15

## Co bylo provedeno

### Eliminace duplikace snapshot kÃ³du
- **OdstranÄ›n obrovskÃ½ inline script** (300+ Å™Ã¡dkÅ¯) z `SnapshotManager.buildInlineScript()`
- **JedinÃ½ zdroj pravdy** â€“ `src/firefox/snapshot/injected/*` je nynÃ­ jedinÃ½m mÃ­stem kde Å¾ije snapshot logika
- OdstranÄ›na duplicita mezi inline verzi a modularizovanou verzi

### Konfigurace bundleru
- **RozÅ¡Ã­Å™en `tsup.config.ts`** pro multi-entry build:
  - `src/index.ts` â†’ `dist/index.js` (ESM, Node.js MCP server)
  - `src/firefox/snapshot/injected/snapshot.injected.ts` â†’ `dist/snapshot.injected.global.js` (IIFE, browser context)
- **IIFE format** s `globalName: '__SnapshotInjected'` pro browser injection
- **Minifikace** zapnuta pro injected bundle (5.54 KB minified)
- **Target: es2020** pro modernÃ­ browser compatibility

### VytvoÅ™enÃ­ UidResolver modulu
- **NovÃ½ soubor `src/firefox/snapshot/resolver.ts`**:
  - VyÄlenÄ›na logika pro UID validation, resolution, caching
  - 160 Å™Ã¡dkÅ¯ ÄistÃ© separace concerns
  - Metody:
    - `validateUid(uid)` â€“ staleness check
    - `resolveUidToSelector(uid)` â€“ UID â†’ CSS selector
    - `resolveUidToElement(uid)` â€“ UID â†’ WebElement (s cachingem)
    - `storeUidMappings(uidMap)` â€“ uklÃ¡dÃ¡nÃ­ mappingÅ¯ ze snapshotu
    - `clear()` â€“ invalidace pÅ™i navigaci

### Refaktor SnapshotManager
- **Å tÃ­hlÃ½ SnapshotManager** (157 Å™Ã¡dkÅ¯ vs. pÅ¯vodnÃ­ 544 Å™Ã¡dkÅ¯ = **-71%**)
- **Lazy loading** bundlovanÃ©ho injected scriptu:
  - NaÄtenÃ­ z `dist/snapshot.injected.global.js` pÅ™i prvnÃ­m pouÅ¾itÃ­
  - Fallback paths pro rÅ¯znÃ¡ prostÅ™edÃ­ (development, production)
  - JasnÃ¡ error message pokud bundle chybÃ­: "Make sure you have run 'npm run build'"
- **Delegace na UidResolver** pro vÅ¡echny UID operace
- **OdstranÄ›nÃ­ buildInlineScript()** â€“ jiÅ¾ nenÃ­ potÅ™eba

### DotÄenÃ© soubory
- `tsup.config.ts` â€“ pÅ™idÃ¡n druhÃ½ entry point pro injected bundle
- `src/firefox/snapshot/manager.ts` â€“ kompletnÃ­ refaktor (544 â†’ 157 Å™Ã¡dkÅ¯)
- `src/firefox/snapshot/resolver.ts` (novÃ½) â€“ UID resolution logika
- `src/firefox/snapshot/injected/*` â€“ beze zmÄ›ny (jiÅ¾ byli source of truth)

## RozhodnutÃ­ a dopady

### ArchitektonickÃ¡ rozhodnutÃ­

1. **IIFE bundle format**
   - PouÅ¾Ã­vÃ¡ `globalName: '__SnapshotInjected'` mÃ­sto pÅ™Ã­mÃ©ho `window.__createSnapshot`
   - UmoÅ¾Åˆuje lepÅ¡Ã­ scope isolation a testovatelnost
   - Bundle registruje funkci pÅ™i injekci: `window.__createSnapshot = __SnapshotInjected.createSnapshot`

2. **Lazy loading bundlu**
   - Bundle se naÄÃ­tÃ¡ aÅ¾ pÅ™i prvnÃ­m `takeSnapshot()` volÃ¡nÃ­
   - Cachuje se v pamÄ›ti pro dalÅ¡Ã­ pouÅ¾itÃ­
   - Redukuje startup overhead

3. **Separation of concerns**
   - `SnapshotManager` â€“ orchestrace, bundling, snapshot creation
   - `UidResolver` â€“ UID validation, mapping, element resolution
   - `injected/*` â€“ browser-side snapshot collection logika
   - `formatter.ts` â€“ text formÃ¡tovÃ¡nÃ­

4. **Build-time bundling**
   - Injected script je bundlovÃ¡n pÅ™i `npm run build`
   - Runtime neobsahuje bundler dependency
   - ProdukÄnÃ­ bundle je minifikovanÃ½ (5.54 KB)

### ZnÃ¡mÃ¡ omezenÃ­

- **Build requirement** â€“ Pokud nÄ›kdo spustÃ­ MCP server bez `npm run build`, snapshot funkce selÅ¾e s jasnou chybou
- **Bundle path resolution** â€“ PouÅ¾Ã­vÃ¡ `process.cwd()` + relative path, coÅ¾ mÅ¯Å¾e bÃ½t fragile v nÄ›kterÃ½ch edge cases (ale pokrÃ½vÃ¡ bÄ›Å¾nÃ© scÃ©nÃ¡Å™e)
- **No source maps** pro injected bundle â€“ debug browser-side kÃ³du je sloÅ¾itÄ›jÅ¡Ã­ (ale kÃ³d je stabilnÃ­)

### Metriky

- **Redukce kÃ³du v SnapshotManager**: 544 â†’ 157 Å™Ã¡dkÅ¯ (**-71%**)
- **Eliminace duplikace**: ~300 Å™Ã¡dkÅ¯ inline JS kÃ³du odstranÄ›no
- **Bundle size**: 5.54 KB minified (IIFE)
- **Build time**: +9ms pro injected bundle (zanedbatelnÃ©)

## TestovÃ¡nÃ­

### Snapshot testy (offline)
```bash
node scripts/test-bidi-devtools.js
âœ… Snapshot taken! (ID: 1)
âœ… UID resolution works
âœ… Staleness detection works
âœ… Iframe support works
```

### VÅ¡echny testy proÅ¡ly
```bash
task check
âœ… ESLint: pass
âœ… TypeScript: pass
âœ… Build: success (2 bundles)

npm run build
âœ… dist/index.js (565.38 KB)
âœ… dist/snapshot.injected.global.js (5.54 KB)
```

## Reference

- Specifikace Ãºkolu: `tasks/28-snapshot-bundling-integration-and-dedup.md`
- PÅ¯vodnÃ­ inline implementace: `src/firefox/snapshot/manager.ts` (Å™Ã¡dky 236-543, nynÃ­ odstranÄ›no)
- ModularizovanÃ½ snapshot kÃ³d: `src/firefox/snapshot/injected/*`
- Bundler konfigurace: Best practices z tsup documentation

## DalÅ¡Ã­ kroky

### KompletnÃ­ roadmapa dokonÄena
- âœ… Tasks 00-28 dokonÄeny
- âœ… VÅ¡echny akceptaÄnÃ­ kritÃ©ria splnÄ›na
- âœ… Testy prochÃ¡zejÃ­

### PotenciÃ¡lnÃ­ vylepÅ¡enÃ­ (volitelnÃ©)
- Source maps pro injected bundle (pro easier debugging)
- Embed bundle pÅ™Ã­mo do `dist/index.js` mÃ­sto separÃ¡tnÃ­ho souboru (eliminuje file I/O)
- Cache warming pÅ™i `FirefoxClient.connect()` (pre-load bundle)
- Compression pro bundle (gzip, ale vÄ›tÅ¡inou nenÃ­ potÅ™eba pro 5KB)

## PoznÃ¡mky

- Snapshot bundling integration eliminovala duplicitnÃ­ kÃ³d a uÄinila `src/firefox/snapshot/injected/*` jedinÃ½m zdrojem pravdy
- UidResolver separace zjednoduÅ¡ila SnapshotManager a zlepÅ¡ila testovatelnost
- Build proces nynÃ­ generuje 2 bundles: MCP server (Node.js) + injected script (browser)
- VÅ¡echny testy prochÃ¡zejÃ­ vÄetnÄ› snapshot staleness detection a iframe support
- **Zero breaking changes** â€“ veÅ™ejnÃ© API zÅ¯stalo stejnÃ©, zmÄ›ny jsou internal only

## ZÃ¡vÄ›r

Task 28 ÃºspÄ›Å¡nÄ› dokonÄil modularizaci snapshot systÃ©mu, eliminoval duplicitnÃ­ kÃ³d (~300 Å™Ã¡dkÅ¯) a zavedl Äistou separaci mezi Node.js a browser-side kÃ³dem. SnapshotManager je nynÃ­ Å¡tÃ­hlÃ½ (157 Å™Ã¡dkÅ¯), UidResolver je samostatnÃ½ modul (160 Å™Ã¡dkÅ¯), a injected kÃ³d je bundlovÃ¡n do minifikovanÃ©ho IIFE (5.54 KB).

**Roadmapa 00-28 je kompletnÄ› hotovÃ¡! ğŸ‰**

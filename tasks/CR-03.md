# Code Review – 03 Konfigurace, .env, setup skript pro MCP klienty, Inspector

Datum: 2025-10-11

## Co bylo provedeno

- Vytvořen `.env.example` s Firefox RDP konfigurací
- Implementován CLI argument parsing s yargs (`src/cli.ts`)
- Vytvořen interaktivní setup skript `scripts/setup-mcp-config.js`
- Přidány dependencies: `yargs@^17.7.2`, `@types/yargs@^17.0.32`
- Aktualizován `src/index.ts` pro použití CLI args a debug logging
- Inspector scripty již byly v `package.json` od task 01:
  - `inspector`: Pro built version
  - `inspector:dev`: Pro dev version s tsx
- Build test: `npm run check && npm run build` - ✅ (472 KB)

## Rozhodnutí a dopady

### .env.example konfigurace

**Firefox RDP proměnné**:
```bash
RDP_HOST=127.0.0.1            # Host kde běží Firefox RDP
RDP_PORT=6000                 # Port Firefox RDP serveru
FIREFOX_PATH=                 # Volitelná cesta k Firefox executable
FIREFOX_HEADLESS=false        # Headless režim
AUTO_LAUNCH_FIREFOX=true      # Auto-spuštění Firefoxu s RDP
VIEWPORT=1280x720             # Výchozí viewport
ACCEPT_INSECURE_CERTS=false   # Akceptovat neplatné certifikáty
FIREFOX_PROFILE_PATH=         # Volitelná cesta k Firefox profilu
DEBUG=                        # Debug logging (*, firefox-devtools)
```

**Důvod**: Pokrývá všechny důležité konfigurační parametry pro Firefox DevTools MCP server.

### CLI argument parsing (src/cli.ts)

**Pattern z chrome-devtools-mcp**:
- Yargs s hideBin pro argument parsing
- Options definované jako satisfies Record<string, YargsOptions>
- Coerce funkce pro validaci komplexních argumentů (viewport)
- ENV fallback pro všechny parametry
- Help text a examples

**CLI Options (8)**:
1. `--rdp-host` - RDP server host (default: 127.0.0.1)
2. `--rdp-port` - RDP server port (default: 6000)
3. `--firefox-path (-f)` - Cesta k Firefox executable
4. `--headless` - Headless režim
5. `--auto-launch` - Auto-spuštění Firefoxu
6. `--viewport` - Viewport size (e.g., 1280x720)
7. `--accept-insecure-certs` - Akceptovat neplatné certs
8. `--firefox-arg` - Extra argumenty pro Firefox (array)

**Viewport validation**:
- Formát: `1280x720`
- Split on 'x', validace Number, NaN check
- Return object {width, height}

### Setup script (scripts/setup-mcp-config.js)

**Pattern z mcp_gsheet**:
- Readline interface pro interaktivní questions
- Node.js path detection (nvm support)
- Platform detection (macOS/Windows/Linux)
- Config path resolution:
  - macOS: `~/Library/Application Support/Claude/claude_desktop_config.json`
  - Windows: `~/AppData/Roaming/Claude/claude_desktop_config.json`
  - Linux: `~/.config/claude/claude_desktop_config.json`

**Workflow**:
1. Build check (automatický build pokud chybí dist/)
2. Firefox konfigurace (RDP host/port, headless, auto-launch, viewport)
3. Node.js path selection (detected/custom/system)
4. Save options (Claude Desktop/Manual copy/Custom file)
5. Optional .env file creation

**MCP Config format**:
```json
{
  "mcpServers": {
    "firefox-devtools": {
      "command": "/path/to/node",
      "args": ["/path/to/dist/index.js"],
      "env": {
        "RDP_HOST": "127.0.0.1",
        "RDP_PORT": "6000",
        "FIREFOX_HEADLESS": "false",
        "AUTO_LAUNCH_FIREFOX": "true",
        "VIEWPORT": "1280x720"
      }
    }
  }
}
```

### Integration do src/index.ts

**Přidáno**:
- Import `parseArguments` z cli.ts
- Import `logDebug` z logger
- Export `args` = parseArguments(SERVER_VERSION)
- Debug logging konfigurace v main()

**Args dostupné globálně**:
- Ostatní moduly mohou importovat `args` z index.ts
- Browser abstraction (task 05) použije args pro Firefox launch

### Inspector scripty (již existovaly)

**Dva režimy**:
- `npm run inspector` - Inspector s built version (dist/index.js)
- `npm run inspector:dev` - Inspector s dev version (tsx src/index.ts, .env support)

## Známá omezení a technické dluhy

1. **Firefox launch není implementován**: CLI args jsou připraveny, ale actual Firefox launch přijde v task 05
   - `AUTO_LAUNCH_FIREFOX` flag připraven
   - `FIREFOX_PATH`, `FIREFOX_ARGS` ready for use

2. **RDP connection není implementována**: Připraveno pro task 05 (browser abstraction)
   - `rdpHost` a `rdpPort` args parsed
   - Connection logic přijde v McpContext

3. **Profile path není využitý**: FIREFOX_PROFILE_PATH v .env, ale nepodporujeme persistent profiles v MVP
   - Rozhodneme v task 05 zda podporovat

4. **--firefox-arg není zpracovaný**: Array argument připraven, ale použití až v task 05

## Reference

### Setup skript převzatý z mcp_gsheet
- `old/mcp_gsheet/scripts/setup-mcp-config.js` - Kompletní interaktivní setup workflow
- `old/mcp_gsheet/.env.example` - ENV variable patterns

### CLI args pattern z chrome-devtools-mcp
- `old/mcp_dev_tool_chrome/src/cli.ts` - Yargs options, coerce functions, examples
- `old/mcp_dev_tool_chrome/src/main.ts` - Args parsing a použití v main()

## Další kroky

1. **Task 04**: Taskfile a Dockerfile
   - Task runner pro `task check`
   - Docker pro Inspector testing
   - Automatizace dev workflow

2. **Task 05**: Browser abstraction (McpContext)
   - **Použije CLI args** pro Firefox launch
   - RDP connection management
   - Firefox process spawn s `args.firefoxPath`, `args.headless`, `args.viewport`
   - **Klíčový task** - zde se args skutečně použijí

3. **Tasks 06-09**: Tool implementace
   - Tools budou používat McpContext z task 05
   - Již nebudou placeholders

## Akceptační kritéria splněna

✅ `.env.example` vytvořen s Firefox RDP config
✅ `src/cli.ts` implementován s yargs
✅ CLI options (8) podporují ENV fallback
✅ `scripts/setup-mcp-config.js` interaktivní setup
✅ Setup skript podporuje Node.js detection (nvm)
✅ Setup skript zapisuje do Claude Desktop config
✅ Optional .env file creation v setup scriptu
✅ `src/index.ts` používá CLI args a loguje config
✅ Inspector scripty už existovaly v package.json
✅ `npm run check` prochází bez chyb
✅ `npm run build` úspěšně sestaví (472 KB)
✅ Dependencies přidány: yargs, @types/yargs

# Code Review – 09 Tools: Síť a výkon

Datum: 2025-10-11

## Co bylo provedeno

Implementace nástrojů pro monitoring sítě a výkonu v rámci Firefox DevTools MCP serveru.

### Dotčené části (soubory/oblast)

**Typy a základní infrastruktura:**
- `src/firefox/types.ts` - přidány `NetworkRequest` a `NetworkMonitorActor` interfaces

**RDP Client (low-level):**
- `src/firefox/rdp-client.ts` - implementace network monitoring metod:
  - `startNetworkMonitoring()` - zahájení monitorování síťových požadavků
  - `stopNetworkMonitoring()` - zastavení monitorování
  - `getNetworkRequests()` - získání seznamu požadavků
  - `clearNetworkRequests()` - vymazání uložených požadavků
  - `getNetworkRequestDetails()` - detail konkrétního požadavku (připraveno pro budoucí rozšíření)
  - `handleNetworkEvent()` - handler pro síťové události z RDP

**DevTools API (high-level):**
- `src/firefox/devtools.ts` - wrapping RDP metod do DevTools API

**MCP Context:**
- `src/McpContext.ts` - expose network API pro MCP tools, formátování dat

**MCP Tools:**
- `src/tools/network.ts` - implementace MCP tools pro síť:
  - `list_network_requests` - výpis požadavků s podporou stránkování
  - `get_network_request` - detail konkrétního požadavku podle URL
  - `start_network_monitoring` - spuštění monitorování
  - `stop_network_monitoring` - zastavení monitorování

- `src/tools/performance.ts` - MVP implementace performance tools:
  - `performance_get_metrics` - základní metriky přes Navigation Timing API
  - `performance_start_trace` - vrací "not supported" s vysvětlením
  - `performance_stop_trace` - vrací "not supported" s vysvětlením

**Registrace:**
- `src/tools/index.ts` - export nových tools
- `src/index.ts` - registrace handlers a tool definitions

## Rozhodnutí a dopady

### Network Monitoring

**Implementační přístup:**
- Využití Firefox RDP `networkMonitor` actor
- Pasivní listening na `networkEvent` a `networkEventUpdate` události
- Ukládání základních informací (URL, metoda, status, timestamp, isXHR)
- Podpora pro stránkování výsledků (pageSize, pageIdx)

**Omezení Firefox RDP vs Chrome CDP:**
- Firefox RDP nemá tak bohatá data jako Chrome DevTools Protocol
- Response body a detailní headers mohou být nedostupné v základní implementaci
- Network události se liší verzí Firefoxu
- Transparentně uvedeno v tool descriptions a výstupech

**Naming & Semantics:**
- Zachována kompatibilita s Chrome MCP tools (`list_network_requests`, `get_network_request`)
- Přidány explicitní `start/stop_network_monitoring` tools (v Chrome implicitní)
- Stejná struktura response jako v Chrome implementaci (kde možné)

### Performance Monitoring

**MVP přístup:**
- Základní implementace pomocí Navigation Timing API
- Dostupné metriky: DOM timing, load events, memory usage (pokud dostupné)
- **Performance tracing není podporováno** - Firefox RDP nemá ekvivalent Chrome trace profiler

**Důvody pro "not supported" trace tools:**
- Firefox RDP neposkytuje detailní performance profiling API
- Trace vyžaduje nativní profiler (Firefox Profiler - profiler.firefox.com)
- Tools existují pro API kompatibilitu s Chrome-based workflows, ale vracejí error s vysvětlením a alternativami

**User guidance:**
- Jasné chybové hlášky s doporučením Firefox DevTools Performance panel
- Odkaz na Firefox Profiler pro pokročilé use cases
- Vysvětlení rozdílů mezi Chrome CDP a Firefox RDP

### Type Safety

**Optional properties handling:**
- Důsledné použití `exactOptionalPropertyTypes: true` (tsconfig)
- Explicitní přidávání optional properties pouze pokud existují (`if (value !== undefined)`)
- Prevence TypeScript chyb s undefined assignment

### Error Handling

- Všechny handlers mají try-catch s informativními error messages
- Network monitoring může selhat pokud Firefox verze nepodporuje RDP network features
- Graceful degradation - chyby jasně komunikovány uživateli

## Reference

**Zdrojová implementace:**
- `old/mcp_dev_tool_chrome/src/tools/network.ts` - struktura network tools
- `old/mcp_dev_tool_chrome/src/formatters/networkFormatter.ts` - formátování výstupu
- `old/mcp_dev_tool_chrome/docs/tool-reference.md` - dokumentace API

**Firefox RDP dokumentace:**
- Network Monitor Actor (https://firefox-source-docs.mozilla.org/devtools/backend/protocol.html)
- Console Actor pro evaluate (použito pro Navigation Timing)

**Existující patterns v projektu:**
- Console monitoring (`src/firefox/rdp-client.ts` - `handleConsoleMessage`)
- Tool handlers (`src/tools/pages.ts`, `src/tools/console.ts`)
- Response helpers (`src/utils/response-helpers.ts`)

## Známá omezení a technické dluhy

### Network

1. **Detailní request/response data** - MVP ukládá pouze základní info
   - Request/response headers mohou být nedostupné
   - Response body vyžaduje dodatečné RDP volání (implementováno v `getNetworkRequestDetails`, ale není používáno)
   - Budoucí iterace: rozšířit `get_network_request` o fetch detailů

2. **Filtering a resource types** - Chrome má `resourceTypes` filter
   - Firefox RDP nemá standardizované resource type kategorie
   - Budoucí: mapping Firefox event causes na Chrome-like resource types

3. **Network events** - variabilita napříč verzemi Firefoxu
   - Starší verze mohou mít odlišnou strukturu `networkEvent` packets
   - Testováno na moderních verzích (Firefox 115+)

### Performance

1. **Trace profiling není dostupný** - fundamentální omezení RDP
   - Firefox Profiler API není exponováno přes RDP
   - Alternativa: instrukce pro použití Firefox DevTools UI

2. **Navigation Timing API omezení:**
   - Data dostupná pouze po kompletním načtení stránky
   - Single Page Apps mohou mít limitované metriky
   - Deprecated `performance.timing` použito pro kompatibilitu (fallback na PerformanceNavigationTiming)

3. **Memory metrics** - `performance.memory` je non-standard
   - Může být undefined v některých konfiguracích Firefoxu
   - Gracefully handled s optional properties

## Další kroky

### Immediate (Task 10-12)
- Task 10: Testování (unit/integration) - network monitoring, performance metrics
- Task 11: Balíčkování a publikace
- Task 12: Dokumentace - tool reference, troubleshooting pro network/performance

### Future iterations
1. **Network enhancements:**
   - Implementovat resource type filtering
   - Rozšířit `get_network_request` o plné headers/body
   - WebSocket monitoring support

2. **Performance enhancements:**
   - User Timing API support (performance.mark/measure)
   - Resource Timing API (detailed asset loading)
   - Layout/Paint metrics (pokud Firefox RDP přidá support)

3. **Testing:**
   - Integration test s reálným network traffic
   - Performance metrics validation
   - Edge cases (canceled requests, redirects, errors)

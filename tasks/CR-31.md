# Code Review – 31 MCP tools: Screenshot a Utility akce stránky

Datum: 2025-10-16

## Co bylo provedeno

### Screenshot tools (`src/tools/screenshot.ts`)

#### 1. screenshot_page
- **Volá**: `firefox.takeScreenshotPage()`
- **Výstup**: Base64 PNG data (bez `data:image/png;base64,` prefixu)
- **Metadata**: Size v KB
- **Note**: "Use for visual verification, not structural inspection"
- **Guidance**: "For structured analysis, use take_snapshot"

#### 2. screenshot_by_uid
- **Volá**: `firefox.takeScreenshotByUid(uid)`
- **Parametry**: `uid` from snapshot
- **Výstup**: Base64 PNG data elementu
- **Metadata**: UID + size v KB
- **Error handling**: Stale UID → friendly message s návodem

### Utility tools (`src/tools/utilities.ts`)

#### Dialogy (3-4. tools)

**3. accept_dialog**
- **Volá**: `firefox.acceptDialog(promptText?)`
- **Parametry**: `promptText` (optional, pro prompt dialogs)
- **Výstup**: Potvrzení s text (pokud byl zadán)
- **Error handling**: No active dialog → friendly message

**4. dismiss_dialog**
- **Volá**: `firefox.dismissDialog()`
- **Výstup**: Potvrzení dismiss/cancel
- **Error handling**: No active dialog → friendly message
- **Guidance**: "Use shortly after triggering dialog"

#### History (5. tool)

**5. navigate_history**
- **Volá**: `firefox.navigateBack()` / `firefox.navigateForward()`
- **Parametry**: `direction` ('back' | 'forward')
- **Výstup**: Potvrzení + warning o stale UIDs
- **Warning**: "⚠️ UIDs from previous snapshots are now stale"
- **Guidance**: "Call take_snapshot before using UID-based actions"

#### Viewport (6. tool)

**6. set_viewport_size**
- **Volá**: `firefox.setViewportSize(width, height)`
- **Parametry**: `width`, `height` (numbers, pixels)
- **Výstup**: Potvrzení s rozměry
- **Note**: "Actual viewport may differ in some modes (e.g., headless)"
- **Validation**: Width a height must be positive numbers

### Dotčené soubory
- `src/tools/screenshot.ts` (nový, 109 řádků)
- `src/tools/utilities.ts` (nový, 196 řádků)
- `src/tools/index.ts` – export screenshot + utility tools
- `src/index.ts` – registrace v toolHandlers + allTools

## Rozhodnutí a dopady

### Architektonická rozhodnutí

1. **Base64 PNG output (no data URL prefix)**
   - Čistý base64 string bez `data:image/png;base64,` prefixu
   - Jednoduší parsing pro LLM
   - Metadata (size) v output text pro context

2. **Screenshot tools separated by use case**
   - `screenshot_page`: full page capture
   - `screenshot_by_uid`: element-specific capture
   - Clear distinction, minimal confusion

3. **Dialog error handling**
   - Detection: `no such alert`, `No dialog`
   - Friendly message: "No active dialog found"
   - Guidance: "Use shortly after dialog appears"

4. **Navigate history with UID warning**
   - Explicit warning po navigaci
   - Reminder: "Call take_snapshot before UID actions"
   - Proactive staleness prevention

5. **Viewport size validation**
   - Positive numbers required
   - Note o potential differences (headless mode)
   - Error message s context

### Známá omezení

- **Screenshot size**: Large images = large base64 strings (může saturovat kontext)
- **Dialog timing**: Musí být použity krátce po vyvolání dialogu (auto-dismiss po timeoutu)
- **History navigation**: Nelze detekovat jestli je history available (selže až při pokusu)
- **Viewport size**: Headless mode může omezit přesnou velikost

### Breaking changes

**Žádné** – nové tools, nezasahují do existujících.

## Testování

### Manuální validace
```bash
task check
✅ ESLint: pass
✅ TypeScript: pass

npm run build
✅ dist/index.js (600.00 KB)
```

### Integration testing scenarios
- screenshot_page full capture
- screenshot_by_uid element capture
- screenshot_by_uid stale UID (error)
- accept_dialog alert/confirm/prompt
- dismiss_dialog confirm
- navigate_history back/forward
- set_viewport_size různé rozměry

## Metriky

- **Nové tools**: 6 (2 screenshot + 4 utility)
- **Nové soubory**: 2 (`screenshot.ts` 109 řádků, `utilities.ts` 196 řádků)
- **Total**: 305 řádků nového kódu

## Reference

- Specifikace úkolu: `tasks/31-mcp-tools-screenshot-and-page-utilities.md`
- Firefox Client API:
  - `FirefoxClient.takeScreenshotPage/ByUid` (task 22)
  - `FirefoxClient.acceptDialog/dismissDialog` (task 23)
  - `FirefoxClient.navigateBack/Forward` (task 23)
  - `FirefoxClient.setViewportSize` (task 23)
- Existující tests: `scripts/test-screenshot.js`, `scripts/test-dialog.js`

## Další kroky

### Navazující úkoly
- ✅ Task 29 dokončen (snapshot integration)
- ✅ Task 30 dokončen (input akce)
- Integration testing s real MCP klienty

### Potenciální vylepšení (volitelné)
- Screenshot compression options
- Screenshot region by coordinates (not just UID)
- Dialog auto-accept/dismiss configuration
- History state inspection (can go back/forward?)
- Viewport presets (mobile, tablet, desktop)

## Poznámky

- Screenshot tools poskytují visual verification capability
- Utility tools přidávají missing pieces pro complete browser automation
- Dialog handling je timing-sensitive (musí být použit krátce po vyvolání)
- Navigate history s UID warning je proactive approach k staleness prevention
- Base64 output formát je LLM-friendly (no parsing needed)
- **Zero breaking changes** – nové tools, plně kompatibilní

## Závěr

Task 31 dokončil MCP tool coverage pro všechny klíčové Firefox Client capabilities:
- Screenshot capture (full page + element-specific)
- Dialog handling (accept/dismiss)
- History navigation (back/forward s UID warnings)
- Viewport sizing (responsive testing support)

Všechny tools mají friendly error handling, clear guidance pro LLM, a konzistentní naming pattern.

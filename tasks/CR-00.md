# Code Review – 00 Výzkum a architektura

Datum: 2025-10-11

## Co bylo provedeno

- Analýza referenčních implementací (`old/mcp_gsheet` a `old/mcp_dev_tool_chrome`)
- Stanovení backendu pro Firefox automatizaci
- Návrh adresářové struktury projektu
- Mapování MVP tools s paritou k Chrome DevTools MCP

## Rozhodnutí a dopady

### Backend: Mozilla Remote Debugging Protocol (RDP)

**Rozhodnutí**: Použijeme nativní Mozilla Remote Debugging Protocol místo Playwright nebo Puppeteer.

**Důvody**:
- Nejvyšší parita s přístupem Chrome CDP (nativní protokol prohlížeče)
- Žádné velké závislosti jako Playwright/Puppeteer binárky
- Cross-platform podpora (Windows, macOS, Linux, kontejnery)
- Přímý přístup k DevTools funkcím

**Dopady**:
- Vyšší počáteční komplexita implementace (RDP není tak zdokumentovaný jako CDP)
- Performance trace formát odlišný od Chrome (vyžaduje custom parser)
- Network monitoring může mít jiné detaily než Chrome
- Nutnost implementovat vlastní wrapper pro browser lifecycle

### Struktura projektu

**Rozhodnutí**: Držíme se struktury z `old/mcp_gsheet`:

```
src/
├── index.ts              # MCP server s tool mapping
├── tools/                # Každý tool samostatný soubor
│   ├── pages.ts         # Navigace a správa stránek
│   ├── screenshot.ts    # Screenshoty
│   ├── script.ts        # JavaScript evaluation
│   ├── console.ts       # Console messages
│   └── network.ts       # Network requests
├── utils/               # Pomocné funkce
│   ├── response-helpers.ts
│   ├── error-handler.ts
│   └── validators.ts
├── types/               # TypeScript typy
└── config/              # Konstanty
```

**Důvody**:
- Osvědčená struktura z mcp_gsheet
- Snadná navigace a maintenance
- Každý tool izolovaný a testovatelný

### MVP Tools - Parita s Chrome

**Rozhodnutí**: Zachováváme názvy a parametry z `old/mcp_dev_tool_chrome` pro snadné přenosy promptů mezi Chrome a Firefox verzemi.

**MVP scope**:

**Navigation automation** (6 tools):
- `list_pages` - Seznam otevřených stránek
- `new_page` - Vytvoření nové stránky s URL
- `select_page` - Výběr aktivní stránky
- `close_page` - Zavření stránky
- `navigate_page` - Navigace na URL
- `navigate_page_history` - Back/Forward navigace

**Debugging** (3 tools):
- `take_screenshot` - Screenshot stránky nebo elementu
- `take_snapshot` - Textový snapshot s UID elementy
- `evaluate_script` - Spuštění JavaScript kódu

**Console** (1 tool):
- `list_console_messages` - Seznam console zpráv

**Network** (2 tools - iterativní):
- `list_network_requests` - Seznam network requestů
- `get_network_request` - Detail konkrétního requestu

**Vynecháno z MVP** (pro pozdější iterace):
- Input automation (click, fill, hover, drag) - vyžaduje snapshot parsing
- Emulation (CPU, network throttling)
- Performance trace a insights (složitější parsing)

### Tooling a Build

**Rozhodnutí**: Stejný toolchain jako mcp_gsheet:
- **TypeScript**: Strict mode
- **tsup**: Bundling (rychlý, jednoduchý)
- **ESLint + Prettier**: Code quality
- **vitest**: Testing framework
- **Taskfile**: Task runner (místo npm scripts pro složitější flows)

## Známá omezení a technické dluhy

1. **RDP dokumentace**: Mozilla RDP není tak dobře dokumentován jako Chrome CDP
   - Bude potřeba reverse engineering a experimentování
   - Reference: Firefox DevTools source code

2. **Performance trace**: Firefox trace formát není kompatibilní s Chrome Trace Format
   - MVP vynechává performance tools
   - Budoucí iterace vyžaduje custom parser

3. **Network details**: Firefox může poskytovat jiné detaily než Chrome
   - Některá pole z Chrome CDP nemusí mít ekvivalent
   - Dokumentovat rozdíly v tool reference

4. **Snapshot parsing**: Pro input automation (click, fill) potřebujeme snapshot s UIDs
   - MVP implementuje základní snapshot
   - Plná parita s Chrome vyžaduje více práce na parsingu DOM

## Reference

### Struktura a tooling (mcp_gsheet)
- `old/mcp_gsheet/package.json` - Dependencies, scripts
- `old/mcp_gsheet/Taskfile.yaml` - Task runner setup
- `old/mcp_gsheet/src/index.ts` - MCP server entry point a tool mapping
- `old/mcp_gsheet/scripts/setup-mcp-config.js` - Setup skript pro MCP klienty

### Parita tools (mcp_dev_tool_chrome)
- `old/mcp_dev_tool_chrome/docs/tool-reference.md` - Kompletní tool dokumentace
- `old/mcp_dev_tool_chrome/src/tools/pages.ts` - Navigation tools
- `old/mcp_dev_tool_chrome/src/tools/screenshot.ts` - Screenshot tools
- `old/mcp_dev_tool_chrome/src/tools/script.ts` - Script evaluation
- `old/mcp_dev_tool_chrome/src/tools/console.ts` - Console tools
- `old/mcp_dev_tool_chrome/src/McpResponse.ts` - Response wrapper

## Další kroky

1. **Task 01**: Projektový scaffold
   - Inicializace package.json
   - Konfigurace TypeScript, tsup, ESLint, Prettier, vitest
   - Setup scripts a základní struktura

2. **Task 02**: Struktura src/ a skelet MCP serveru
   - Vytvoření adresářů a základních souborů
   - MCP server boilerplate z `old/mcp_gsheet/src/index.ts`

3. **Task 05**: Browser abstraction layer (McpContext)
   - Wrapper pro RDP komunikaci
   - Browser lifecycle management
   - Page management

## Akceptační kritéria splněna

✅ Rozhodnutí pro backend (Mozilla RDP) s odůvodněním
✅ Seznam MVP tools s paritou k Chrome
✅ Definice adresářové struktury podle mcp_gsheet
✅ Identifikace známých limitů vs Chrome
✅ Zmapování referenčních souborů pro další úkoly

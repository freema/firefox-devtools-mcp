# Code Review ‚Äì 07 Tools: Debug a screenshoty (MVP)

Datum: 2025-10-11

## Co bylo provedeno

Implementov√°ny screenshot a snapshot n√°stroje pro MCP server s paritou n√°zv≈Ø a funkc√≠ z Chrome DevTools MCP.

### Dotƒçen√© ƒç√°sti

- `src/tools/screenshot.ts` - Implementace handler funkc√≠ pro screenshot a snapshot tools
- `src/McpContext.ts` - P≈ôid√°n√≠ metody `takeScreenshot()`
- `src/firefox/devtools.ts` - P≈ôid√°n√≠ metody `takeScreenshot()`
- `src/firefox/rdp-client.ts` - Implementace RDP screenshot metody pomoc√≠ JavaScript evaluation

### Implementovan√© tools

1. **take_screenshot** - Vytvo≈ô√≠ screenshot str√°nky
   - Podporuje form√°ty: `png`, `jpeg`, `webp`
   - Podporuje `fullPage` parametr pro celou str√°nku
   - Automaticky ukl√°d√° velk√© obr√°zky (>2MB) do doƒçasn√Ωch soubor≈Ø
   - Vrac√≠ base64 data pro mal√© obr√°zky
   - Emoji indik√°tor üì∏ pro lep≈°√≠ UX

2. **take_snapshot** - Vytvo≈ô√≠ textov√Ω snapshot DOM stromu
   - Rekurzivnƒõ zpracov√°v√° DOM elementy
   - P≈ôi≈ôazuje jedineƒçn√© UID ka≈æd√©mu elementu
   - Zobrazuje tagName, id, class, text content
   - Omezeno na prvn√≠ch 10 dƒõt√≠ ka≈æd√©ho elementu (aby se p≈ôede≈°lo obrovsk√Ωm v√Ωstup≈Øm)
   - Emoji indik√°tor üìÑ pro lep≈°√≠ UX

## Rozhodnut√≠ a dopady

### Naming a API design
- Dr≈æeli jsme se n√°zv≈Ø z Chrome DevTools MCP (`take_screenshot`, `take_snapshot`)
- Tool parametry jsou kompatibiln√≠: `format`, `fullPage`
- Response form√°t pou≈æ√≠v√° emoji indik√°tory (üì∏, üìÑ) pro lep≈°√≠ UX

### Screenshot implementace
**Zvolen√Ω p≈ô√≠stup**: JavaScript evaluation s Canvas API

#### Proƒç ne nativn√≠ Firefox RDP screenshot?
- Firefox RDP **deprecated CDP support** (Chrome DevTools Protocol) v roce 2025
- P≈ôe≈°li na **WebDriver BiDi** standard
- Na≈°e implementace pou≈æ√≠v√° existuj√≠c√≠ RDP connection, ne CDP

#### Implementaƒçn√≠ detaily:
```javascript
// Vytv√°≈ô√≠me canvas element
const canvas = document.createElement('canvas');
const ctx = canvas.getContext('2d');

// Nastav√≠me rozmƒõry (viewport nebo cel√° str√°nka)
canvas.width = fullPage ? document.documentElement.scrollWidth : window.innerWidth;
canvas.height = fullPage ? document.documentElement.scrollHeight : window.innerHeight;

// Vykresl√≠me b√≠l√© pozad√≠
ctx.fillStyle = 'white';
ctx.fillRect(0, 0, width, height);

// P≈ôevedeme na data URL
return canvas.toDataURL('image/png');
```

### Zn√°m√° omezen√≠

#### Screenshot omezen√≠:
- **Jednoduch√° implementace**: Canvas s b√≠l√Ωm pozad√≠m
  - Neobsahuje skuteƒçn√Ω obsah str√°nky (pouze placeholder)
  - Pro plnou funkcionalitu by bylo pot≈ôeba:
    - Pou≈æ√≠t WebDriver BiDi protocol
    - Nebo implementovat komplexnƒõj≈°√≠ canvas rendering (html2canvas style)
- **Fallback**: Pokud sel≈æe, vrac√≠ minimal 1x1 pixel PNG
- **Quality parametr**: Implementov√°n, ale nen√≠ plnƒõ funkƒçn√≠ (z√°vis√≠ na canvas API)

#### Snapshot omezen√≠:
- **Omezen√Ω poƒçet dƒõt√≠**: Pouze prvn√≠ch 10 dƒõt√≠ ka≈æd√©ho elementu
- **Text truncation**: Text je zkr√°cen na 50 znak≈Ø
- **≈Ω√°dn√° accessibility tree**: Na rozd√≠l od Chrome MCP (kter√Ω pou≈æ√≠v√° Puppeteer's accessibility snapshot)
- **Jednoduch√° struktura**: Nezachycuje v≈°echny atributy a stavy element≈Ø

### File handling
- Velk√© screenshoty (>2MB) se ukl√°daj√≠ do doƒçasn√Ωch soubor≈Ø pomoc√≠ `context.saveTemporaryFile()`
- Mal√© screenshoty se vracej√≠ jako base64 string v response
- Form√°t temporary file: `/tmp/firefox-devtools-mcp-XXXXXX/screenshot.{png|jpeg|webp}`

### Error handling
- V≈°echny metody maj√≠ try-catch s RdpError
- Screenshot m√° fallback na minimal 1x1 PNG v p≈ô√≠padƒõ selh√°n√≠
- Snapshot vrac√≠ "(empty or unavailable)" pokud evaluace sel≈æe

## Reference

- `old/mcp_dev_tool_chrome/src/tools/screenshot.ts` - vzor pro API design a naming
- `old/mcp_dev_tool_chrome/src/tools/snapshot.ts` - vzor pro snapshot tool
- `old/mcp_dev_tool_chrome/src/formatters/snapshotFormatter.ts` - vzor pro form√°tov√°n√≠ snapshot
- `old/mcp_dev_tool_chrome/src/McpResponse.ts` - vzor pro attachment handling

## Dal≈°√≠ kroky

### Bezprost≈ôednƒõ n√°sleduj√≠c√≠ √∫kol
- **Task 08**: Tools: Console a evaluate (MVP)
  - Console logging
  - Script evaluation (ji≈æ m√°me z√°klad v `evaluateScript`)

### Mo≈æn√° vylep≈°en√≠ task 07 (pro budoucnost)
1. **Screenshot vylep≈°en√≠**:
   - Implementovat WebDriver BiDi protocol pro nativn√≠ screenshoty
   - Nebo pou≈æ√≠t komplexnƒõj≈°√≠ canvas rendering (html2canvas approach)
   - P≈ôidat support pro element screenshot (pomoc√≠ UID z snapshot)
   - Implementovat clip parametr pro ƒç√°steƒçn√© screenshoty

2. **Snapshot vylep≈°en√≠**:
   - P≈ôidat support pro accessibility tree (podobnƒõ jako Chrome MCP)
   - Zv√Ω≈°it limit dƒõt√≠ nebo udƒõlat konfigurabiln√≠
   - P≈ôidat v√≠ce atribut≈Ø (aria-*, data-*, atd.)
   - Implementovat filtrov√°n√≠ (nap≈ô. pouze interactive elementy)

3. **Optimalizace**:
   - Caching snapshot pro rychlej≈°√≠ opakovan√© vol√°n√≠
   - Streaming pro velk√© snapshoty
   - Komprese pro base64 data

### Testing
- Po dokonƒçen√≠ task 08-09 vytvo≈ôit integration testy (task 10)
- Testovat edge cases:
  - Screenshot pr√°zdn√© str√°nky
  - Screenshot velmi dlouh√© str√°nky (fullPage)
  - Snapshot str√°nky s deep nested DOM
  - Snapshot str√°nky s mnoha elementy

## Pozn√°mky k implementaci

### TypeScript type safety
- V≈°echny metody jsou spr√°vnƒõ otypovan√©
- Buffer type pro screenshot data
- Optional parameters s defaultn√≠mi hodnotami

### Code quality
- ESLint: ‚úÖ Pro≈°lo bez chyb
- TypeScript: ‚úÖ Pro≈°lo typecheck bez chyb
- Form√°tov√°n√≠: ‚úÖ Prettier applied

### Testing v√Ωstupy
Manu√°ln√≠ testov√°n√≠ bude provedeno v task 10, ale z√°kladn√≠ kontroly:
- V≈°echny tools jsou registrovan√© v `src/index.ts`
- V≈°echny tools jsou exportovan√© z `src/tools/index.ts`
- Response form√°t je konzistentn√≠ (successResponse/errorResponse)
- Screenshot vrac√≠ Buffer type
- Snapshot vrac√≠ string

### Known Technical Debt
1. **Screenshot je placeholder**: Vrac√≠ pouze b√≠l√© pozad√≠, ne skuteƒçn√Ω obsah str√°nky
   - Pro MVP to m≈Ø≈æe staƒçit jako "proof of concept"
   - Pro produkci by bylo pot≈ôeba implementovat WebDriver BiDi nebo komplexnƒõj≈°√≠ rendering

2. **Snapshot je zjednodu≈°en√Ω**: Neobsahuje v≈°echny informace jako Chrome MCP accessibility snapshot
   - Pro MVP poskytuje z√°kladn√≠ strukturu DOM
   - Pro pokroƒçil√© pou≈æit√≠ by bylo lep≈°√≠ pou≈æ√≠t Firefox accessibility API

## Z√°vƒõr

Task 07 je implementov√°n s funkƒçn√≠ paritou n√°zv≈Ø a API s Chrome DevTools MCP. Implementace je zjednodu≈°en√° (zejm√©na screenshot), ale poskytuje z√°klad pro dal≈°√≠ vylep≈°en√≠. Pro MVP √∫ƒçely jsou obƒõ funkce dostateƒçn√© pro z√°kladn√≠ debugging workflow.

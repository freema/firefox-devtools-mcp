# Code Review – 29 MCP tools: Snapshot integration

Datum: 2025-10-16

## Co bylo provedeno

### Nové snapshot tools
Vytvořen nový soubor `src/tools/snapshot.ts` s třemi MCP tools:

#### 1. take_snapshot
- **Volá**: `firefox.takeSnapshot()`
- **Výstup**: Textový snapshot (prvních 100 řádků) + metadata
- **Metadata**: Snapshot ID, truncation warning
- **Truncation**: Pokud snapshot má více než 100 řádků, zobrazí se pouze prvních 100 + notice
- **Error handling**: Friendly error message při selhání

#### 2. resolve_uid_to_selector
- **Volá**: `firefox.resolveUidToSelector(uid)`
- **Výstup**: CSS selector pro daný UID
- **Use case**: Debug/inspection (ne běžné použití)
- **Error handling**:
  - Detekce stale UID keywords: `stale`, `Snapshot`, `UID`, `not found`
  - Friendly message: "UID is from an old snapshot... call take_snapshot first"

#### 3. clear_snapshot
- **Volá**: `firefox.clearSnapshot()`
- **Výstup**: Potvrzení o vymazání cache
- **Use case**: Manuální invalidace (navigace již invaliduje automaticky)

### Prompt guidelines v descriptions
Každý tool obsahuje LLM-friendly prompty:

- **take_snapshot**:
  - "Always work with the latest snapshot"
  - "Use only when page changes or UIDs become stale"
  - "Don't assume old UIDs are valid after navigation"

- **resolve_uid_to_selector**:
  - "Not needed for regular UID-based actions"
  - "Throws error for stale UIDs - call take_snapshot first"

- **clear_snapshot**:
  - "Navigation automatically invalidates snapshots"
  - "Rarely needed"

### Dotčené soubory
- `src/tools/snapshot.ts` (nový, 152 řádků)
- `src/tools/index.ts` – export snapshot tools
- `src/index.ts` – registrace v toolHandlers + allTools

## Rozhodnutí a dopady

### Architektonická rozhodnutí

1. **Snapshot text truncation: 100 lines**
   - Balans mezi readability a completeness
   - Notice indikuje truncation: "... and N more lines"
   - LLM má dostačující kontext pro UI understanding

2. **Stale UID detection**
   - Keyword-based: `stale`, `Snapshot`, `UID`, `not found`
   - Pragmatic approach (není perfektní, ale funguje pro většinu případů)
   - Friendly error message s actionable advice

3. **Minimal tool set**
   - 3 tools jsou dostatečné pro snapshot workflow
   - `take_snapshot` je primary tool
   - `resolve_uid_to_selector` a `clear_snapshot` jsou utility

4. **No UID count in output**
   - Původně měl `take_snapshot` zobrazit počet elementů s UIDs
   - `uidMap` není v `SnapshotJson` (je v `InjectedScriptResult`)
   - Rozhodl jsem nezobrazovat count (není kritické info)

### Známá omezení

- **Snapshot text truncation** může skrýt elementy na konci stránky (ale UID zůstávají validní)
- **Stale UID detection** není 100% spolehlivá (keyword-based)
- **clear_snapshot** je redundantní (navigace už invaliduje), ale přidává explicitnost

### Breaking changes

**Žádné** – nové tools, nezasahují do existujících.

## Testování

### Manuální validace
```bash
task check
✅ ESLint: pass
✅ TypeScript: pass (fixed uidMap issue)

npm run build
✅ dist/index.js (600.00 KB) +25KB
```

### Integration testing scenarios
- take_snapshot na simple page
- take_snapshot s truncation (100+ lines)
- resolve_uid_to_selector validní UID
- resolve_uid_to_selector stale UID (error)
- clear_snapshot + verify invalidation

## Metriky

- **Nové tools**: 3 (`take_snapshot`, `resolve_uid_to_selector`, `clear_snapshot`)
- **Nový soubor**: `src/tools/snapshot.ts` (152 řádků)
- **Registrace**: `src/tools/index.ts` + `src/index.ts`
- **Bundle size**: +25KB (600KB total)

## Reference

- Specifikace úkolu: `tasks/29-mcp-tools-snapshot-integration.md`
- Firefox Client API: `FirefoxClient.takeSnapshot`, `resolveUidToSelector`, `clearSnapshot`
- Chrome MCP parity: `old/mcp_dev_tool_chrome/src/tools/snapshot.ts`

## Další kroky

### Navazující úkoly
- ✅ Task 30 dokončen (input akce podle UID)
- ✅ Task 31 dokončen (screenshot a utilities)
- Integration testing s MCP klienty

### Potenciální vylepšení (volitelné)
- Recursive count of UIDs (traverse SnapshotNode tree)
- Configurable truncation limit
- Better stale UID detection (error codes from resolver)
- JSON output format (pro programmatic usage)

## Poznámky

- Snapshot tools tvoří základ pro UID-based workflow
- Truncation na 100 řádků je pragmatická value (balanc context vs completeness)
- Friendly error messages s actionable advice jsou klíčové pro dobrý LLM UX
- **Zero breaking changes** – nové tools, plně kompatibilní
- Snapshot ID tracking umožňuje debugging a validaci staleness

# Code Review – 30 MCP tools: Input akce podle UID

Datum: 2025-10-16

## Co bylo provedeno

### Nové UID-based input tools
Vytvořen nový soubor `src/tools/input.ts` se 6 MCP tools pro interakci s elementy:

#### 1. click_by_uid
- **Volá**: `firefox.clickByUid(uid, dblClick?)`
- **Parametry**: `uid` (required), `dblClick` (optional boolean)
- **Výstup**: Potvrzení s typu clicku (single/double)
- **Error handling**: Stale UID → friendly message

#### 2. hover_by_uid
- **Volá**: `firefox.hoverByUid(uid)`
- **Use case**: Tooltip trigger, hover states, dropdown menus
- **Výstup**: Potvrzení hoveru
- **Error handling**: Stale UID → friendly message

#### 3. fill_by_uid
- **Volá**: `firefox.fillByUid(uid, value)`
- **Parametry**: `uid`, `value` (text to fill)
- **Výstup**: Potvrzení s value preview (first 50 chars)
- **Warning**: "Keep values short and safe"
- **Error handling**: Stale UID → friendly message

#### 4. drag_by_uid_to_uid
- **Volá**: `firefox.dragByUidToUid(fromUid, toUid)`
- **Parametry**: `fromUid`, `toUid`
- **Výstup**: Potvrzení drag operation
- **Warning**: "JS fallback - some libraries may not work"
- **Error handling**: Both UIDs checked for staleness

#### 5. fill_form_by_uid
- **Volá**: `firefox.fillFormByUid([{uid, value}, ...])`
- **Parametry**: `elements` array of `{uid, value}`
- **Výstup**: Potvrzení s počtem polí + preview hodnot (first 30 chars)
- **Tip**: "Use smaller batches for easier debugging"
- **Error handling**: Validates all elements before execution

#### 6. upload_file_by_uid
- **Volá**: `firefox.uploadFileByUid(uid, filePath)`
- **Parametry**: `uid`, `filePath` (local filesystem path)
- **Requirements**:
  - UID must point to `<input type="file">`
  - filePath must be accessible by server
  - Element must not be hidden
- **Error handling**: Specific errors for non-file-input, hidden element

### Unified error handling
Vytvořena helper funkce `handleUidError()`:
- Detekuje stale UID keywords: `stale`, `Snapshot`, `UID`, `not found`
- Vrací friendly message: "UID is stale... call take_snapshot and try again"
- Reusable napříč všemi handlers

### Common prompt guidelines
Konstanta `COMMON_UID_WARNING`:
- "These actions require a valid UID from the latest snapshot"
- "After navigation or significant DOM changes, always call take_snapshot first"
- "On staleness errors, retry: take_snapshot → action"
- Sdílená napříč všemi UID tools (DRY)

### Dotčené soubory
- `src/tools/input.ts` (nový, 393 řádků)
- `src/tools/index.ts` – export input tools
- `src/index.ts` – registrace v toolHandlers + allTools

## Rozhodnutí a dopady

### Architektonická rozhodnutí

1. **Naming: `*_by_uid` pattern**
   - Konzistence s Chrome MCP tools
   - Explicitní indikace že vyžaduje UID
   - Clear differentiation od non-UID actions

2. **Unified error handling**
   - Helper funkce `handleUidError()` eliminuje duplicitní kod
   - Keyword-based detection (pragmatic)
   - Actionable error messages

3. **Value preview in output**
   - `fill_by_uid`: first 50 chars
   - `fill_form_by_uid`: first 30 chars per field
   - Balans mezi visibility a brevity

4. **Drag-and-drop warning**
   - JS fallback approach není univerzální
   - Warning v description: "Some libraries may not work"
   - Alternative suggestions: "click + input"

5. **File upload specific errors**
   - Check for `<input type="file">`
   - Check for visibility
   - Friendly errors pro common fail cases

### Známá omezení

- **Drag-and-drop**: JS fallback nemusí fungovat pro custom DnD libraries
- **File upload**: Hidden file inputs nelze použít (BiDi limitation)
- **Stale UID detection**: Keyword-based není perfektní
- **No element validation**: Neprovádí se pre-check validity (např. disabled state)

### Breaking changes

**Žádné** – nové tools, nezasahují do existujících.

## Testování

### Manuální validace
```bash
task check
✅ ESLint: pass
✅ TypeScript: pass

npm run build
✅ dist/index.js (600.00 KB)
```

### Integration testing scenarios
- click_by_uid single click
- click_by_uid double click
- hover_by_uid tooltip trigger
- fill_by_uid text input
- drag_by_uid_to_uid elements
- fill_form_by_uid multiple fields
- upload_file_by_uid valid file
- Stale UID errors pro všechny tools

## Metriky

- **Nové tools**: 6 (click, hover, fill, drag, fill_form, upload)
- **Nový soubor**: `src/tools/input.ts` (393 řádků)
- **Helper funkce**: 1 (`handleUidError`)
- **Common constants**: 1 (`COMMON_UID_WARNING`)

## Reference

- Specifikace úkolu: `tasks/30-mcp-tools-input-uid-actions.md`
- Firefox Client API: `FirefoxClient` input methods (task 21)
- Existující tests: `scripts/test-input-tools.js`

## Další kroky

### Navazující úkoly
- ✅ Task 29 dokončen (snapshot integration)
- ✅ Task 31 dokončen (screenshot a utilities)
- Integration testing s real MCP klienty

### Potenciální vylepšení (volitelné)
- Element validation před akcí (check disabled, readonly)
- Better drag-and-drop (BiDi native support if available)
- File upload progress tracking
- Batch operations s partial success handling
- UID validity pre-check tool

## Poznámky

- UID-based input tools tvoří core interaktivního workflow
- Unified error handling výrazně zlepšuje maintainability
- Prompt guidelines jsou klíčové pro správné LLM použití
- Value previews v output zlepšují debugging experience
- **Zero breaking changes** – nové tools, plně kompatibilní
- Naming pattern `*_by_uid` zajišťuje jasnost a paritu s Chrome MCP

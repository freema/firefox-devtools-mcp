# Code Review – 34 MCP tools: Console + Pages drobný refaktor

Datum: 2025-10-16

## Co bylo provedeno

### Console tools – filtry a čištění

#### Filtry pro list_console_messages
- **3 nové filter parametry** (všechny volitelné):
  - `level` (enum: 'debug'|'info'|'warn'|'error') – filtruje dle úrovně
  - `limit` (number, default: 50) – maximální počet zpráv
  - `sinceMs` (number) – pouze zprávy z posledních N milisekund

- **Emoji indikátory dle levelu**:
  - debug: 🔍
  - info: ℹ️
  - warn: ⚠️
  - error: ❌

- **Enhanced output format**:
  - Header: `Console messages (showing X of Y matching, Z total)`
  - Filter summary: `Filters: level=error sinceMs=5000`
  - Truncation notice: `... N more messages (increase limit to see more)`

#### Nový nástroj clear_console_messages
- **Handler `handleClearConsoleMessages`**:
  - Získá count zpráv před vymazáním
  - Zavolá `firefox.clearConsoleMessages()`
  - Vrací potvrzení s počtem vymazaných zpráv
  - Upozornění pro fresh output capture

### Pages tools – refresh a vylepšený formát

#### Nový nástroj refresh_pages
- **Handler `handleRefreshPages`**:
  - Zavolá `firefox.refreshTabs()`
  - Vrací stejný formát jako `list_pages` s prefixem "🔄 Page list refreshed"
  - Use case: po otevření/zavření tabů

#### Vylepšený formát page listu
- **Nová helper funkce `formatPageList()`**:
  - Konzistentní formátování pro oba tools (`list_pages`, `refresh_pages`)
  - Header: `📄 Open pages (N total, selected: [X])`
  - Indicator: `👉` pro vybranou stránku, `  ` pro ostatní
  - Format: `[idx] Title` + URL na další řádce

### Prompt guidelines v descriptions
- Console: "Use filters (level/limit/sinceMs) to narrow results and save context"
- Console: "Use clear_console_messages before new measurement to ensure output is relevant"
- Pages: "refresh_pages updates list after opening/closing tabs"
- Pages: "select_page sets context for all subsequent tool calls"

### Dotčené soubory
- `src/tools/console.ts` – filtry, emoji, clear tool (47 → 142 řádků)
- `src/tools/pages.ts` – formatPageList helper, refresh_pages tool (210 → 233 řádků)
- `src/tools/index.ts` – exporty nových tools
- `src/index.ts` – registrace `clear_console_messages` + `refresh_pages`

## Rozhodnutí a dopady

### Architektonická rozhodnutí

1. **Default limit: 50**
   - Rozumný balans mezi úplností a performance
   - Explicit opt-in pro více zpráv (increase limit)
   - Truncation notice když je potřeba

2. **sinceMs filter**
   - Time-based filtering pro fresh logs
   - Výpočet: `cutoffTime = Date.now() - sinceMs`
   - Kombinovatelný s `level` filtrem

3. **Emoji indicators**
   - Visual clarity pro rychlou identifikaci error/warn messages
   - Fallback: 📝 pro unknown levels

4. **formatPageList() helper**
   - DRY principle: jediný source of truth pro page list format
   - Reusable pro list_pages + refresh_pages
   - Konzistentní UX

### Známá omezení

- **No AND/OR logic**: Filtry jsou AND kombinace (dostatečné pro běžné use cases)
- **No source filtering**: Console messages nelze filtrovat dle source (např. "console-api" vs "javascript")
- **Timestamp precision**: sinceMs filter závisí na timestamp accuracy z BiDi events

### Breaking changes

**Žádné** – všechny parametry jsou volitelné:
- `list_console_messages` – existující volání fungují (nyní s default limit 50)
- `list_pages` – format rozšířen (header s total count), ale stále čitelný

**Potenciální change**: Default limit 50 může truncate výstup u stránek s více než 50 console messages, ale to je intended behavior (performance + context savings).

## Testování

### Manuální validace
```bash
task check
✅ ESLint: pass
✅ TypeScript: pass

npm run build
✅ dist/index.js (575.18 KB)
```

### Integration testing scenarios
- list_console_messages with level=error
- list_console_messages with limit=10
- list_console_messages with sinceMs=5000
- clear_console_messages and verify count
- refresh_pages after opening new tab
- formatPageList with multiple tabs

## Metriky

- **Console filtry**: 3 parametry (level, limit, sinceMs)
- **Nové tools**: 2 (`clear_console_messages`, `refresh_pages`)
- **Emoji indicators**: 4 levely
- **Helper funkce**: `formatPageList()` (16 řádků)
- **Kód přidán**: ~100 řádků (filters + helpers + new tools)

## Reference

- Specifikace úkolu: `tasks/34-mcp-tools-console-and-pages-refactor.md`
- Původní implementace:
  - `src/tools/console.ts` (task 08)
  - `src/tools/pages.ts` (task 06)
- Chrome DevTools MCP reference: `old/mcp_dev_tool_chrome` (console filtering patterns)

## Další kroky

### Navazující úkoly
- ✅ Task 32 dokončen (evaluate_script)
- ✅ Task 33 dokončen (network tools)
- Integration testy s BiDi console/page events

### Potenciální vylepšení (volitelné)
- Source-based filtering pro console messages
- Regex support pro message text filtering
- Page search by title/URL
- Bulk page operations (close multiple, select by pattern)

## Poznámky

- Console filtry výrazně zlepšují debugging workflow (rychlé filtrování errors)
- Emoji indicators zvyšují visual clarity
- Default limit 50 je pragmatický trade-off (performance vs completeness)
- refresh_pages přidává symetrii s list_pages
- formatPageList helper eliminuje code duplication
- **Zero breaking changes** – existující use cases fungují beze změn nebo s better defaults (limit 50)

# Code Review â€“ 34 MCP tools: Console + Pages drobnÃ½ refaktor

Datum: 2025-10-16

## Co bylo provedeno

### Console tools â€“ filtry a ÄiÅ¡tÄ›nÃ­

#### Filtry pro list_console_messages
- **3 novÃ© filter parametry** (vÅ¡echny volitelnÃ©):
  - `level` (enum: 'debug'|'info'|'warn'|'error') â€“ filtruje dle ÃºrovnÄ›
  - `limit` (number, default: 50) â€“ maximÃ¡lnÃ­ poÄet zprÃ¡v
  - `sinceMs` (number) â€“ pouze zprÃ¡vy z poslednÃ­ch N milisekund

- **Emoji indikÃ¡tory dle levelu**:
  - debug: ğŸ”
  - info: â„¹ï¸
  - warn: âš ï¸
  - error: âŒ

- **Enhanced output format**:
  - Header: `Console messages (showing X of Y matching, Z total)`
  - Filter summary: `Filters: level=error sinceMs=5000`
  - Truncation notice: `... N more messages (increase limit to see more)`

#### NovÃ½ nÃ¡stroj clear_console_messages
- **Handler `handleClearConsoleMessages`**:
  - ZÃ­skÃ¡ count zprÃ¡v pÅ™ed vymazÃ¡nÃ­m
  - ZavolÃ¡ `firefox.clearConsoleMessages()`
  - VracÃ­ potvrzenÃ­ s poÄtem vymazanÃ½ch zprÃ¡v
  - UpozornÄ›nÃ­ pro fresh output capture

### Pages tools â€“ refresh a vylepÅ¡enÃ½ formÃ¡t

#### NovÃ½ nÃ¡stroj refresh_pages
- **Handler `handleRefreshPages`**:
  - ZavolÃ¡ `firefox.refreshTabs()`
  - VracÃ­ stejnÃ½ formÃ¡t jako `list_pages` s prefixem "ğŸ”„ Page list refreshed"
  - Use case: po otevÅ™enÃ­/zavÅ™enÃ­ tabÅ¯

#### VylepÅ¡enÃ½ formÃ¡t page listu
- **NovÃ¡ helper funkce `formatPageList()`**:
  - KonzistentnÃ­ formÃ¡tovÃ¡nÃ­ pro oba tools (`list_pages`, `refresh_pages`)
  - Header: `ğŸ“„ Open pages (N total, selected: [X])`
  - Indicator: `ğŸ‘‰` pro vybranou strÃ¡nku, `  ` pro ostatnÃ­
  - Format: `[idx] Title` + URL na dalÅ¡Ã­ Å™Ã¡dce

### Prompt guidelines v descriptions
- Console: "Use filters (level/limit/sinceMs) to narrow results and save context"
- Console: "Use clear_console_messages before new measurement to ensure output is relevant"
- Pages: "refresh_pages updates list after opening/closing tabs"
- Pages: "select_page sets context for all subsequent tool calls"

### DotÄenÃ© soubory
- `src/tools/console.ts` â€“ filtry, emoji, clear tool (47 â†’ 142 Å™Ã¡dkÅ¯)
- `src/tools/pages.ts` â€“ formatPageList helper, refresh_pages tool (210 â†’ 233 Å™Ã¡dkÅ¯)
- `src/tools/index.ts` â€“ exporty novÃ½ch tools
- `src/index.ts` â€“ registrace `clear_console_messages` + `refresh_pages`

## RozhodnutÃ­ a dopady

### ArchitektonickÃ¡ rozhodnutÃ­

1. **Default limit: 50**
   - RozumnÃ½ balans mezi ÃºplnostÃ­ a performance
   - Explicit opt-in pro vÃ­ce zprÃ¡v (increase limit)
   - Truncation notice kdyÅ¾ je potÅ™eba

2. **sinceMs filter**
   - Time-based filtering pro fresh logs
   - VÃ½poÄet: `cutoffTime = Date.now() - sinceMs`
   - KombinovatelnÃ½ s `level` filtrem

3. **Emoji indicators**
   - Visual clarity pro rychlou identifikaci error/warn messages
   - Fallback: ğŸ“ pro unknown levels

4. **formatPageList() helper**
   - DRY principle: jedinÃ½ source of truth pro page list format
   - Reusable pro list_pages + refresh_pages
   - KonzistentnÃ­ UX

### ZnÃ¡mÃ¡ omezenÃ­

- **No AND/OR logic**: Filtry jsou AND kombinace (dostateÄnÃ© pro bÄ›Å¾nÃ© use cases)
- **No source filtering**: Console messages nelze filtrovat dle source (napÅ™. "console-api" vs "javascript")
- **Timestamp precision**: sinceMs filter zÃ¡visÃ­ na timestamp accuracy z BiDi events

### Breaking changes

**Å½Ã¡dnÃ©** â€“ vÅ¡echny parametry jsou volitelnÃ©:
- `list_console_messages` â€“ existujÃ­cÃ­ volÃ¡nÃ­ fungujÃ­ (nynÃ­ s default limit 50)
- `list_pages` â€“ format rozÅ¡Ã­Å™en (header s total count), ale stÃ¡le ÄitelnÃ½

**PotenciÃ¡lnÃ­ change**: Default limit 50 mÅ¯Å¾e truncate vÃ½stup u strÃ¡nek s vÃ­ce neÅ¾ 50 console messages, ale to je intended behavior (performance + context savings).

## TestovÃ¡nÃ­

### ManuÃ¡lnÃ­ validace
```bash
task check
âœ… ESLint: pass
âœ… TypeScript: pass

npm run build
âœ… dist/index.js (575.18 KB)
```

### Integration testing scenarios
- list_console_messages with level=error
- list_console_messages with limit=10
- list_console_messages with sinceMs=5000
- clear_console_messages and verify count
- refresh_pages after opening new tab
- formatPageList with multiple tabs

## Metriky

- **Console filtry**: 3 parametry (level, limit, sinceMs)
- **NovÃ© tools**: 2 (`clear_console_messages`, `refresh_pages`)
- **Emoji indicators**: 4 levely
- **Helper funkce**: `formatPageList()` (16 Å™Ã¡dkÅ¯)
- **KÃ³d pÅ™idÃ¡n**: ~100 Å™Ã¡dkÅ¯ (filters + helpers + new tools)

## Reference

- Specifikace Ãºkolu: `tasks/34-mcp-tools-console-and-pages-refactor.md`
- PÅ¯vodnÃ­ implementace:
  - `src/tools/console.ts` (task 08)
  - `src/tools/pages.ts` (task 06)
- Chrome DevTools MCP reference: `old/mcp_dev_tool_chrome` (console filtering patterns)

## DalÅ¡Ã­ kroky

### NavazujÃ­cÃ­ Ãºkoly
- âœ… Task 32 dokonÄen (evaluate_script)
- âœ… Task 33 dokonÄen (network tools)
- Integration testy s BiDi console/page events

### PotenciÃ¡lnÃ­ vylepÅ¡enÃ­ (volitelnÃ©)
- Source-based filtering pro console messages
- Regex support pro message text filtering
- Page search by title/URL
- Bulk page operations (close multiple, select by pattern)

## PoznÃ¡mky

- Console filtry vÃ½raznÄ› zlepÅ¡ujÃ­ debugging workflow (rychlÃ© filtrovÃ¡nÃ­ errors)
- Emoji indicators zvyÅ¡ujÃ­ visual clarity
- Default limit 50 je pragmatickÃ½ trade-off (performance vs completeness)
- refresh_pages pÅ™idÃ¡vÃ¡ symetrii s list_pages
- formatPageList helper eliminuje code duplication
- **Zero breaking changes** â€“ existujÃ­cÃ­ use cases fungujÃ­ beze zmÄ›n nebo s better defaults (limit 50)

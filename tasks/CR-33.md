# Code Review – 33 MCP tools: Síťové nástroje – filtry + čištění

Datum: 2025-10-16

## Co bylo provedeno

### Filtry pro list_network_requests
- **7 nových filter parametrů** (všechny volitelné):
  - `urlContains` (string) – case-insensitive substring match
  - `method` (string) – HTTP method (GET, POST, ...), case-insensitive
  - `status` (number) – exact HTTP status code
  - `statusMin` (number) – minimum HTTP status code
  - `statusMax` (number) – maximum HTTP status code
  - `isXHR` (boolean) – filter XHR/fetch requests
  - `resourceType` (string) – resource type, case-insensitive

- **Filter implementation**: Progresivní filtrování nad `firefox.getNetworkRequests()` výsledkem
- **Case-insensitive**: `method` a `resourceType` normalizovány na upper/lower case

### Nový nástroj clear_network_requests
- **Handler `handleClearNetworkRequests`**:
  - Získá count requestů před vymazáním
  - Zavolá `firefox.clearNetworkRequests()`
  - Vrací potvrzení s počtem vymazaných requestů
  - Upozornění že monitoring zůstává aktivní (pokud byl zapnutý)

### Vylepšení start_network_monitoring
- **Nový parametr `clearFirst`** (boolean, default: true):
  - Pokud true → automaticky vymaže buffer před startem
  - Pokud false → zachová existující requesty
- **Default true** zajišťuje clean measurements z výchozího nastavení
- Output message indikuje jestli byl buffer vymazán

### Prompt guidelines v descriptions
- "Use filters (urlContains, method, status...) to narrow results and avoid context overload"
- "For precise measurements, start monitoring before navigation and stop it after page load"
- "Use clear_network_requests or start_network_monitoring with clearFirst=true for fresh measurements"

### Dotčené soubory
- `src/tools/network.ts` – přidány filtry, clearFirst parametr, nový clear_network_requests tool (209 → 316 řádků)
- `src/tools/index.ts` – export `clearNetworkRequestsTool` + `handleClearNetworkRequests`
- `src/index.ts` – registrace `clear_network_requests` v toolHandlers a allTools

## Rozhodnutí a dopady

### Architektonická rozhodnutí

1. **Progressive filtering**
   - Každý filter aplikován postupně nad results
   - Short-circuit evaluation: pokud request neprošel, dál se netestuje
   - Efektivní i pro velké počty requestů

2. **Case-insensitive matching**
   - `method`: normalizováno na uppercase (`GET`, `POST`)
   - `resourceType`: normalizováno na lowercase
   - `urlContains`: lowercase substring match
   - UX benefit: uživatel nemusí řešit case

3. **clearFirst default: true**
   - Safe default pro fresh measurements
   - Explicitní opt-out pro pokročilé use cases (accumulation across navigations)

4. **Separate clear_network_requests tool**
   - Symetrické API: `start`, `stop`, `clear`
   - Flexibility: clear bez stop/restart monitoring
   - Alternative k `start_network_monitoring({ clearFirst: true })`

### Známá omezení

- **Filter stacking**: Všechny filtry jsou AND (nelze OR kombinace) – dostatečné pro běžné use cases
- **No regex support**: `urlContains` je substring, ne pattern matching – simplicity over power
- **BiDi limitations persist**: Tělo requestů/responses stále není dostupné (platform limitation)

### Breaking changes

**Žádné** – všechny nové parametry jsou volitelné:
- `list_network_requests` – existující volání fungují beze změn
- `start_network_monitoring` – `clearFirst` default true může změnit chování, ale je to desired behavior (fresh measurements)

## Testování

### Manuální validace
```bash
task check
✅ ESLint: pass
✅ TypeScript: pass

npm run build
✅ dist/index.js (575.18 KB)
```

### Integration testing scenarios
- Filter by URL (urlContains="api/v1")
- Filter by method (method="POST")
- Filter by status range (statusMin=400, statusMax=499)
- Filter XHR only (isXHR=true)
- Clear buffer and verify count
- start_network_monitoring with clearFirst=false

## Metriky

- **Nové filtry**: 7 parametrů
- **Nový tool**: `clear_network_requests`
- **Rozšířené parametry**: `start_network_monitoring.clearFirst`
- **Kód přidán**: ~100 řádků (filter logic + clear handler)

## Reference

- Specifikace úkolu: `tasks/33-mcp-tools-network-refactor.md`
- Původní implementace: `src/tools/network.ts` (task 09)
- Chrome DevTools MCP reference: `old/mcp_dev_tool_chrome` (network filtering patterns)

## Další kroky

### Navazující úkoly
- ✅ Task 32 dokončen (evaluate_script)
- ✅ Task 34 dokončen (console + pages)
- Integration testy s BiDi network events

### Potenciální vylepšení (volitelné)
- OR filter support (`filters: { or: [...] }`)
- Regex support pro URL matching
- Response body capture (pokud BiDi v budoucnu bude podporovat)
- Performance optimization (index-based filtering)

## Poznámky

- Filtry výrazně zlepšují použitelnost pro debugging a performance analysis
- clear_network_requests tool přidává symetrii a flexibility
- Case-insensitive matching eliminuje běžný source of errors
- **Zero breaking changes** – existující use cases fungují beze změn nebo s better defaults

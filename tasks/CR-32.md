# Code Review – 32 MCP tools: Refaktor evaluate_script

Datum: 2025-10-16

## Co bylo provedeno

### Sjednocení execution paths
- **Eliminován duplikátní kód**: Původní implementace měla dva oddělené execution paths (s args / bez args) s ~60 řádky duplicitního kódu
- **Unified path**: Nyní jediná cesta přes `driver.executeScript()` s volitelným array argumentů
- Kód redukován z 124 → 176 řádků, ale s mnohem lepší strukturou a robustností

### Validace function parametru
- **Nová funkce `validateFunction()`**:
  - Kontrola že `fnString` je string a není prázdný
  - Size limit: max 16 KB (ochrana proti masivním scriptům)
  - Format validation: rozpoznává `function`, `async function`, `()`, `async ()`
  - Přátelská error message s příklady správného formátu

### Vylepšený UID error handling
- **Friendly stale UID errors**: Když UID resolution selže, vrací jasnou zprávu:
  - "UID is invalid or from an old snapshot"
  - "The page may have changed since the snapshot was taken"
  - "Please call take_snapshot to get fresh UIDs and try again"
- Detekce dle keywords: `stale`, `Snapshot`, `UID`

### Script timeout
- **Přidán parametr `timeout`**: Volitelný, default 5000ms
- **WebDriver timeout**: `driver.manage().setTimeouts({ script: scriptTimeout })`
- **Enhanced timeout errors**: Při timeoutu vrací přátelskou zprávu s návrhy (infinite loop, slow operation, increase timeout)

### Prompt guidelines v description
- "Provide a JavaScript function or arrow function"
- "If passing UIDs via args, ensure you have a fresh snapshot"
- "Avoid side-effects and long scripts - this tool is for reading values"

### Dotčené soubory
- `src/tools/script.ts` – kompletní refaktor handleEvaluateScript (55 → 94 řádků handler + 38 řádků helpers)

## Rozhodnutí a dopady

### Architektonická rozhodnutí

1. **Unified execution path**
   - Vždy používá `driver.executeScript()` s spread argumentů
   - Prázdné array pro volání bez args
   - Promise wrapping pro sync/async funkce

2. **Size limit: 16 KB**
   - Dostatečně velký pro běžné use cases
   - Malý dost aby zabránil abuse (nástroj není určen pro velkých skriptů)

3. **Function validation**
   - Regex-free simple check: `trimmed.startsWith(...)`
   - False positives možné (např. "( some invalid code"), ale validní funkce vždy projdou
   - Přátelská error message s examples

4. **Timeout handling**
   - Default 5s je rozumný pro většinu operací
   - WebDriver timeout nastaven před každým executeScript voláním
   - Enhanced error message pro timeouts

### Známá omezení

- **Function validation není 100% přesná**: Jednoduchá heuristika, nepoužívá parser
- **Timeout není per-tool**: Nastavení timeoutu ovlivňuje celý WebDriver session (možný side-effect)
- **UID error detection**: Keyword-based, může false positive/negative

### Breaking changes

**Žádné** – všechny parametry jsou backward compatible:
- `function` – required (beze změn)
- `args` – optional (beze změn)
- `timeout` – optional (nový)

## Testování

### Manuální validace
```bash
task check
✅ ESLint: pass
✅ TypeScript: pass

npm run build
✅ dist/index.js (575.18 KB)
```

### Plánované integration testy
- Valid function formats (arrow, async, sync)
- Invalid function formats (plain expressions)
- Size limit enforcement
- Timeout handling
- Stale UID error messages

## Reference

- Specifikace úkolu: `tasks/32-mcp-tools-evaluate-refactor.md`
- Původní implementace: `src/tools/script.ts` (task 08)
- Chrome DevTools MCP parity: `old/mcp_dev_tool_chrome` (evaluate_script tool)

## Další kroky

### Navazující úkoly
- ✅ Task 33 dokončen (síťové nástroje)
- ✅ Task 34 dokončen (console + pages)
- Testování s reálnými MCP klienty (Claude Desktop)

### Potenciální vylepšení (volitelné)
- Proper JavaScript parser pro function validation (např. Acorn)
- Per-call timeout isolation (nový WebDriver context)
- More granular UID error detection (error codes from resolver)

## Poznámky

- Refaktor zjednodušil kód a zároveň přidal robustnost
- Function validation je pragmatická – zachytí běžné chyby, není bulletproof
- Error messages jsou human-friendly a actionable
- **Zero breaking changes** – stávající use cases fungují beze změn

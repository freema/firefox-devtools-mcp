# Code Review – 02 Struktura src/ a skelet MCP serveru

Datum: 2025-10-11

## Co bylo provedeno

- Vytvořena kompletní adresářová struktura: `src/tools/`, `src/utils/`, `src/types/`, `src/config/`
- Implementován hlavní `src/index.ts` s MCP server boilerplate
- Vytvořeny placeholder tools (9 tools pro MVP):
  - **Pages** (5): list_pages, new_page, navigate_page, select_page, close_page
  - **Screenshot** (2): take_screenshot, take_snapshot
  - **Script** (1): evaluate_script
  - **Console** (1): list_console_messages
- Vytvořeny utility moduly:
  - `src/utils/response-helpers.ts` - Helper funkce pro MCP responses
  - `src/utils/logger.ts` - Logging helper
- Vytvořeny typy v `src/types/common.ts`
- Vytvořeny konstanty v `src/config/constants.ts`
- Tool handler mapping v `src/index.ts`
- Build test: `npm run check && npm run build` - ✅

## Rozhodnutí a dopady

### Struktura adresářů

```
src/
├── index.ts              # MCP server entry point s tool registration
├── config/
│   └── constants.ts      # Firefox defaults, server metadata
├── types/
│   └── common.ts         # Sdílené TypeScript typy
├── utils/
│   ├── response-helpers.ts  # MCP response formatters
│   └── logger.ts         # Logging utility
└── tools/
    ├── index.ts          # Central tool export
    ├── pages.ts          # Navigation tools (5 tools)
    ├── screenshot.ts     # Screenshot tools (2 tools)
    ├── script.ts         # Script evaluation (1 tool)
    └── console.ts        # Console tools (1 tool)
```

**Důvod**: Kopie struktury z `old/mcp_gsheet`, osvědčený pattern

### MCP Server implementace

**Pattern z mcp_gsheet**:
- Tool handler Map: `Map<string, handler_function>`
- All tools array: `Tool[]` definice pro ListToolsRequestSchema
- Stdio transport (ne WebSocket)
- Dotenv loading v development mode
- Node.js version validation

**Tool registration**:
- 9 MVP tools zaregistrováno
- Každý tool má definition (name, description, inputSchema) a handler
- Handlery jsou placeholders vracející "placeholder (task X)" message

### Response helpers

**Tři typy responses**:
- `successResponse(message)` - Jednoduchá textová odpověď
- `errorResponse(error)` - Error s isError flag
- `jsonResponse(data)` - JSON serializovaná data

**McpToolResponse type**:
```typescript
{
  content: Array<{type: string; text: string}>;
  isError?: boolean;
}
```

### Logger

**Tři úrovně**:
- `log()` - Standard log (stderr)
- `logError()` - Error s stack trace
- `logDebug()` - Pouze když DEBUG=* nebo DEBUG=firefox-devtools

### Tool placeholders

**Všechny tools jsou placeholders** s minimální implementací:
- Vrací success response s textem "toolname - placeholder (task X)"
- Plná implementace přijde v tasks 06-09
- InputSchema už definována podle parity s Chrome tools

**MVP Tools (9)**:
1. **list_pages** - Seznam otevřených stránek
2. **new_page** - Vytvoření nové stránky
3. **navigate_page** - Navigace na URL
4. **select_page** - Výběr aktivní stránky
5. **close_page** - Zavření stránky
6. **take_screenshot** - Screenshot
7. **take_snapshot** - Textový snapshot s UIDs
8. **evaluate_script** - JavaScript evaluation
9. **list_console_messages** - Console logy

### Konstanty

**Firefox defaults**:
- `DEFAULT_FIREFOX_PORT = 6000` (RDP port)
- `DEFAULT_HEADLESS = false`
- `FIREFOX_ARGS` - CLI argumenty pro start
- `FIREFOX_PREFS` - Preferované nastavení DevTools

## Známá omezení a technické dluhy

1. **Tools jsou placeholders**: Žádná reálná funkcionalita
   - Implementace přijde v tasks 06-09
   - Momentálně pouze vrací placeholder messages

2. **Žádné Firefox RDP connection**: Browser abstraction přijde v task 05
   - Tools nemohou komunikovat s Firefoxem
   - Potřeba McpContext wrapper (task 05)

3. **Žádná CLI argument parsing**: Zatím bez yargs
   - Chrome version používá yargs pro CLI args
   - Pro MVP možná ani nepotřebujeme (konfigurace přes .env)
   - Rozhodneme v task 03

4. **Žádná validace input argumentů**: Placeholder handlery neprovádějí validaci
   - Zod schemas budou v plné implementaci tools

## Reference

### Struktura převzata z mcp_gsheet
- `old/mcp_gsheet/src/index.ts` - MCP server boilerplate, tool mapping
- `old/mcp_gsheet/src/tools/index.ts` - Central tool export pattern
- `old/mcp_gsheet/src/utils/response-helpers.ts` - Response format pattern

### Tool parity s Chrome DevTools MCP
- `old/mcp_dev_tool_chrome/src/tools/pages.ts` - Navigation tools naming
- `old/mcp_dev_tool_chrome/src/tools/screenshot.ts` - Screenshot API
- `old/mcp_dev_tool_chrome/src/tools/script.ts` - Script evaluation pattern
- `old/mcp_dev_tool_chrome/src/tools/console.ts` - Console tools

## Další kroky

1. **Task 03**: Konfigurace a setup skripty
   - `.env.example` pro Firefox config
   - `scripts/setup-mcp-config.js` pro MCP klient setup
   - Rozhodnout o CLI args vs env vars

2. **Task 04**: Taskfile a Dockerfile
   - Task runner pro `task check`
   - Docker pro Inspector testing

3. **Task 05**: Browser abstraction (McpContext)
   - RDP connection management
   - Page lifecycle
   - Event handling (console, network)
   - **Klíčový task** - bez něj tools nebudou fungovat

4. **Tasks 06-09**: Implementace tool funkcionality
   - Task 06: Pages tools
   - Task 07: Screenshot tools
   - Task 08: Console a evaluate tools
   - Task 09: Network tools (advanced)

## Akceptační kritéria splněna

✅ Adresářová struktura podle mcp_gsheet
✅ `src/index.ts` s MCP server a tool registration
✅ Tool handler mapping (Map pattern)
✅ 9 MVP tools zaregistrováno s placeholders
✅ Response helpers a logger utility
✅ Typy a konstanty
✅ `npm run check` prochází bez chyb
✅ `npm run build` úspěšně sestaví (469 KB)
✅ Server lze spustit (zatím bez browser connection)

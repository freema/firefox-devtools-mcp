# Code Review – 05 Vrstva prohlížeče (McpContext/browser wrapper)

Datum: 2025-10-11

## Co bylo provedeno

- Vytvořen kompletní MVP RDP klient pro Firefox DevTools
- Implementovány klíčové moduly:
  - `src/firefox/types.ts` - RDP typy a interfaces
  - `src/firefox/transport.ts` - TCP transport s JSON framing
  - `src/firefox/rdp-client.ts` - Low-level RDP klient
  - `src/firefox/launcher.ts` - Firefox process launcher
  - `src/firefox/devtools.ts` - High-level DevTools API
  - `src/McpContext.ts` - MCP bridge pro tools
- Integrace do `src/index.ts` s lazy initialization
- Build: **493 KB** ✅

## Rozhodnutí a dopady

### Architektura (hybridní C → A přístup)

**MVP funkčnost implementována**:
1. ✅ TCP transport s length-prefixed JSON framing
2. ✅ RDP root discovery (getRoot + listTabs fallback)
3. ✅ Tab listing a attachment
4. ✅ Navigation (navigateTo)
5. ✅ JavaScript evaluation (evaluateJSAsync)
6. ✅ Page content extraction (via evaluate)
7. ✅ Firefox launcher s platform detection

**Placeholders pro budoucí iterace**:
- Console logs (TODO: Task 08)
- Network requests (TODO: Task 09)
- Screenshots (TODO: Task 07)
- Performance traces (future)

### src/firefox/types.ts

**Core types**:
```typescript
type ActorId = string;
interface RdpPacket { from?: ActorId; to?: ActorId; type?: string; [key: string]: unknown; }
interface Tab { actor: ActorId; title: string; url: string; consoleActor?: ActorId; ... }
interface AttachResult { consoleActor: ActorId; threadActor: ActorId; }
class RdpError extends Error { code, reason, actor, payload }
interface FirefoxLaunchOptions { firefoxPath?, headless, rdpHost, rdpPort, ... }
```

**Důležité**:
- `ActorId` je string (Firefox RDP actor identifikátor)
- `RdpPacket` je volný object (flexibilní pro různé RDP příkazy)
- `RdpError` má structured error info (code, reason, actor, payload)

### src/firefox/transport.ts (TCP + JSON framing)

**Protocol**: Firefox RDP používá `<length>:<json>` framing
- Příklad: `48:{"to":"root","type":"listTabs"}` (48 bytů JSON)

**Implementation**:
- `connect(host, port, timeout)` - Socket connection s timeoutem
- `send(packet)` - Serializuje packet a přidá length prefix
- `handleData(data)` - Parsuje incoming messages, emituje 'message' event
- `close()` - Zavře socket a vyčistí buffer

**Buffer management**:
- Incremental parsing (handles partial messages)
- Delimiter detection (`:`)
- Length validation (parseInt check)
- JSON parsing error handling

**Důvod**: Vlastní implementace místo knihovny - máme plnou kontrolu nad debug/stability.

### src/firefox/rdp-client.ts (Low-level RDP)

**Core methods (MVP)**:
- `connect(host, port)` - Connect + root discovery
- `listTabs()` - Seznam otevřených tabů
- `attachToTab(tabActor)` - Attach k tabu (vrací consoleActor, threadActor)
- `navigateTo(tabActor, url)` - Navigace na URL
- `evaluateJS(consoleActor, code)` - Evaluate JavaScript
- `getPageContent(tabActor, consoleActor)` - Extrahuje HTML přes evaluate

**Root discovery**:
```typescript
// Try getRoot first (newer API)
await this.sendRequest('root', { type: 'getRoot' });
// Fallback: listTabs (older API)
await this.sendRequest('root', { type: 'listTabs' });
```
**Důvod**: Backwards compatibility s různými verzemi Firefoxu.

**Request/response correlation**:
- Per-actor queue: `Map<ActorId, PendingRequest[]>`
- Timeout per request (10s default)
- Match by `from` field v response
- Unsolicited events logují debug (budoucí event bus)

**Error handling**:
- Timeout errors: `RdpError('TIMEOUT', ...)`
- RDP protocol errors: `RdpError('RDP_ERROR', ...)`
- Connection errors propagují up

### src/firefox/launcher.ts (Firefox process spawn)

**Platform detection**:
- macOS: `/Applications/Firefox.app/Contents/MacOS/firefox`
- Linux: `/usr/bin/firefox`, `/usr/bin/firefox-esr`
- Windows: `C:\Program Files\Mozilla Firefox\firefox.exe`

**Args construction**:
```bash
--start-debugger-server=6000  # Enable RDP
--headless                     # Headless mode (optional)
--no-remote                    # Disable default browser check
--foreground                   # Keep in foreground
--width=1280 --height=720      # Viewport (optional)
--profile <path>               # Profile path (optional)
about:blank                    # Initial URL
```

**Startup detection**:
- Listen for stderr: "Listening on port" nebo "DevTools listening"
- Fallback: 10s timeout (assume success)
- Delay 1s po detekci pro plnou inicializaci

**Cleanup**:
- Graceful: `SIGTERM` first
- Force: `SIGKILL` after 5s timeout
- Process tracking: `this.process !== null && !this.process.killed`

### src/firefox/devtools.ts (High-level API)

**State management**:
```typescript
private tabs: Tab[] = [];
private selectedTabIdx = 0;
private selectedTab: SelectedTab | null = null;  // Attached tab with actors
```

**SelectedTab structure**:
```typescript
interface SelectedTab {
  tab: Tab;
  tabActor: ActorId;
  consoleActor: ActorId;
  threadActor: ActorId;
}
```

**Connect workflow**:
1. Try connect to existing Firefox (rdpHost:rdpPort)
2. If fail + launcher not created → auto-launch Firefox
3. Retry connection after launch
4. Refresh tabs and select first one

**API methods**:
- `refreshTabs()` - Re-fetch tab list
- `selectTab(idx)` - Switch active tab (attach if needed)
- `navigate(url)` - Navigate current tab
- `evaluate(code)` - Run JS in current tab
- `getContent()` - Get page HTML

**Placeholders**:
- `getConsoleLogs()` - Throws "not implemented (Task 08)"
- `getNetworkRequests()` - Throws "not implemented (Task 09)"
- `takeScreenshot()` - Throws "not implemented (Task 07)"

### src/McpContext.ts (MCP Bridge)

**Purpose**: Unified interface mezi MCP tools a Firefox DevTools

**API pro tools**:
```typescript
// Page management
async getPages(): Promise<PageInfo[]>  // Seznam stránek s indexy
async setSelectedPageIdx(idx: number)  // Výběr stránky
async getSelectedPage(): Promise<PageInfo>  // Aktuální stránka

// Navigation
async navigatePage(url: string)  // Navigace na URL

// Script execution
async evaluateScript<T>(code: string): Promise<T>  // Evaluate JS

// Content
async getPageContent(): Promise<string>  // HTML content

// File storage
async saveTemporaryFile(data, mimeType): Promise<{filename}>  // Pro screenshots
async saveFile(data, filename): Promise<{filename}>
```

**PageInfo interface**:
```typescript
interface PageInfo {
  idx: number;
  title: string;
  url: string;
  selected: boolean;
}
```

**Temporary file storage**:
- Creates temp dir: `os.tmpdir() + 'firefox-devtools-mcp-'`
- Saves with extension: `screenshot.png`, `screenshot.jpeg`, `screenshot.webp`
- Returns absolute path

### Integrace do src/index.ts

**Lazy initialization**:
```typescript
let context: McpContext | null = null;

export async function getContext(): Promise<McpContext> {
  if (!context) {
    const options: FirefoxLaunchOptions = { /* from CLI args */ };
    context = await McpContext.create(options);
  }
  return context;
}
```

**Důvod**: Context vytváříme až při prvním tool call (šetříme resources pokud tools nejsou použity).

**Options mapping** (CLI args → FirefoxLaunchOptions):
- `args.firefoxPath` → `firefoxPath`
- `args.headless` → `headless`
- `args.rdpHost` → `rdpHost`
- `args.rdpPort` → `rdpPort`
- `args.profilePath` → `profilePath`
- `args.viewport` → `viewport`
- `args.firefoxArg` → `args`

## Známá omezení a technické dluhy

1. **RDP protocol není plně implementován**: MVP pokrývá jen core funkce
   - Console API chybí (task 08)
   - Network API chybí (task 09)
   - Screenshot API chybí (task 07)
   - Performance API není v plánu pro MVP

2. **No event bus**: Unsolicited RDP events (navigation, console) se logují ale nepropagují
   - Pro MVP stačí polling (refreshTabs())
   - Event-driven architecture možná v budoucnu

3. **Single selected tab**: Server sleduje pouze jednu vybranou stránku
   - Paralel

ní operace na více tabech nejsou podporovány
   - Pro MVP dostačující

4. **No retry logic**: Connect/navigate mají 1 attempt, pak fail
   - Pro MVP přijatelné
   - Retry lze přidat později

5. **No WebSocket fallback**: Pouze TCP transport
   - Firefox RDP primárně používá TCP
   - WebSocket support možný v budoucnu

6. **Platform detection není exhaustive**: Hledá jen common paths
   - User může override --firefox-path
   - Pro většinu případů stačí

7. **No profile management**: Firefox vždy používá temporary/default profile
   - `--profile` arg připraven ale neotestován
   - Persistent profiles možná později

## Reference

### Pattern převzatý z chrome-devtools-mcp
- `old/mcp_dev_tool_chrome/src/McpContext.ts` - Context structure, temp file storage
- Chrome používá Puppeteer, my RDP - jiná implementace, podobné API

### Vlastní implementace RDP
- Žádná kvalitní Node.js knihovna pro Firefox RDP
- ~500 LOC vlastní implementace - plná kontrola

## Další kroky

1. **Task 06**: Tools - Navigace a správa stránek
   - Implementovat `list_pages`, `new_page`, `navigate_page`, `select_page`, `close_page`
   - Použít `context.getPages()`, `context.navigatePage()`, atd.
   - **Přímé využití McpContext API**

2. **Task 07**: Tools - Debug a screenshoty
   - Implementovat `take_screenshot`, `take_snapshot`
   - Screenshot API do `rdp-client.ts` a `devtools.ts`

3. **Task 08**: Tools - Console a evaluate
   - Implementovat `evaluate_script`, `list_console_messages`
   - Console API do `rdp-client.ts` (subscribe na console events)

4. **Task 09**: Tools - Síť a výkon (optional)
   - Network request monitoring
   - Performance metrics

## Akceptační kritéria splněna

✅ TCP transport s JSON framing implementován
✅ RDP root discovery (getRoot + listTabs fallback)
✅ `listTabs()` vrací seznam tabů
✅ `attachToTab()` attach k tabu
✅ `navigateTo()` naviguje na URL
✅ `evaluateJS()` evaluate JavaScript
✅ `getPageContent()` extrahuje HTML
✅ Firefox launcher s platform detection
✅ Auto-launch workflow (try connect → launch → retry)
✅ McpContext bridge pro tools
✅ Lazy initialization v src/index.ts
✅ Placeholders pro console/network/screenshot s TODO
✅ `npm run check` prochází bez chyb
✅ `npm run build` úspěšně sestaví (493 KB)
✅ Error handling s RdpError
✅ Timeout management (10s per request)
✅ Temporary file storage připraven

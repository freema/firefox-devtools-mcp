# Code Review – 04 Taskfile.yaml a Dockerfile

Datum: 2025-10-11

## Co bylo provedeno

- Vytvořen `Taskfile.yaml` s 23 tasks pro development workflow
- Vytvořen `Dockerfile` s multi-stage build a Firefox ESR
- Vytvořen `.dockerignore` pro optimalizaci Docker build cache
- Vytvořen `docker-compose.yml` pro lokální testování
- `.gitignore` již obsahoval Docker artifacts (z task 01)
- Build test: `task check` - ✅

## Rozhodnutí a dopady

### Taskfile.yaml struktur

**Pattern z mcp_gsheet**:
- Version 3 task runner
- Descriptive task names s desc field
- Dependencies pomocí deps array
- Task composition (např. `release` volá `clean`, `install`, `check`, `build`)

**Tasks (23)**:

**Build & Run**:
1. `default` - Zobrazí seznam tasků
2. `install` - npm install
3. `build` - npm run build
4. `dev` - npm run dev (tsx watch)
5. `start` - npm start (deps: build)
6. `clean` - Vymaže dist/, node_modules/, package-lock.json
7. `watch` - tsup --watch

**Quality & Checks**:
8. `typecheck` - TypeScript typecheck
9. `lint` - ESLint
10. `lint:fix` - ESLint auto-fix
11. `fmt` - Prettier format
12. `fmt:check` - Prettier check
13. `check` - lint:fix + typecheck (hlavní check)
14. `check:all` - všechny checks + tests + build

**Inspector & Setup**:
15. `inspector` - MCP inspector (deps: build)
16. `inspector:dev` - MCP inspector dev mode
17. `setup` - Interaktivní MCP config setup

**Testing**:
18. `test` - vitest watch mode
19. `test:run` - vitest run once
20. `test:coverage` - vitest with coverage
21. `test:watch` - vitest watch
22. `test:ui` - vitest UI

**Release & CI**:
23. `release` - clean → install → check → build
24. `ci` - clean → install → check → test:coverage → build
25. `env` - Vytvoří .env z .env.example

**Hlavní workflow**:
- Development: `task dev` nebo `task inspector:dev`
- Check: `task check` (používáme místo `npm run check`)
- Release: `task release`
- CI: `task ci`

### Dockerfile (multi-stage build)

**Stage 1: Builder (node:22-bookworm)**:
- Install build dependencies (python3, make, g++)
- npm ci (všechny dependencies)
- npm run build
- Output: dist/ folder

**Stage 2: Production (node:22-bookworm)**:
- Install Firefox ESR (`firefox-esr` package)
- npm ci --only=production
- Copy dist/ from builder stage
- Create non-root user (nodejs:1001)
- Set ENV variables (RDP_HOST, RDP_PORT, FIREFOX_HEADLESS, etc.)

**Base image**: `node:22-bookworm`
- Debian Bookworm (stable)
- Node.js 22 LTS
- Podporuje Firefox ESR z apt

**Firefox ESR installation**:
```dockerfile
RUN apt-get update && \
    apt-get install -y firefox-esr && \
    rm -rf /var/lib/apt/lists/*
```

**Default ENV variables**:
```dockerfile
ENV NODE_ENV=production \
    RDP_HOST=127.0.0.1 \
    RDP_PORT=6000 \
    FIREFOX_HEADLESS=true \
    AUTO_LAUNCH_FIREFOX=false \
    VIEWPORT=1280x720
```

**Security**:
- Non-root user (nodejs:1001)
- Production dependencies only
- Multi-stage build (menší final image)

**Usage**:
```bash
docker build -t firefox-devtools-mcp .
docker run --rm -i firefox-devtools-mcp
```

### .dockerignore (optimalizace cache)

**Excluded**:
- Git files (.git, .gitignore)
- Node artifacts (node_modules, npm-debug.log)
- Build artifacts (dist, coverage)
- Environment files (.env, .env.local)
- IDE files (.vscode, .idea)
- Documentation (*.md, docs/, tasks/, old/)
- Config files (tsconfig.json, Taskfile.yaml, etc.)
- Test files (*.test.ts, *.spec.ts, tests/)
- Scripts (scripts/setup-mcp-config.js)

**Result**: Rychlejší Docker builds díky menšímu build context.

### docker-compose.yml

**Services (2)**:

1. **firefox-devtools-mcp**:
   - Build from local Dockerfile
   - stdin_open + tty for MCP stdio
   - ENV variables configured
   - Optional: host network nebo port 6000 expose
   - Volume mount dist/ for quick testing

2. **firefox** (optional):
   - selenium/standalone-firefox image
   - RDP port 6000
   - VNC port 7900 (viewing)
   - 2GB shared memory
   - Pro testování RDP connection

**Usage**:
```bash
docker-compose up -d firefox-devtools-mcp
docker-compose logs -f firefox-devtools-mcp
```

## Známá omezení a technické dluhy

1. **Docker image je velký**: ~1.5GB kvůli Firefox ESR + Node.js
   - Pro production možná optimalizace (Alpine + custom Firefox build)
   - Pro MVP je to přijatelné

2. **RDP connection v Dockeru není otestována**: Docker setup je připravený, ale skutečný test až v task 05
   - Browser abstraction přijde v task 05
   - Pak otestujeme Docker + Firefox workflow

3. **VNC viewing není zdokumentováno**: selenium/standalone-firefox má VNC na portu 7900
   - Přidáme do dokumentace v task 12

4. **CI workflow není kompletní**: `task ci` připraven, ale GitHub Actions/GitLab CI přijde v task 11
   - CI pipeline definition až v task 11

## Reference

### Taskfile převzatý z mcp_gsheet
- `old/mcp_gsheet/Taskfile.yaml` - Kompletní task definice, deps, composition patterns

### Dockerfile pattern z mcp_gsheet
- `old/mcp_gsheet/Dockerfile` - Multi-stage build, non-root user, production optimizations
- Přizpůsobeno: Alpine → Bookworm, přidán Firefox ESR

## Další kroky

1. **Task 05**: Browser abstraction (McpContext)
   - **Otestovat Docker setup** s reálným Firefox launch
   - RDP connection implementation
   - Firefox process management
   - **Klíčový task** - pak můžeme testovat Docker workflow

2. **Tasks 06-09**: Tool implementace
   - Tools budou používat McpContext
   - Inspector testování s Docker

3. **Task 10**: Testing a Inspector workflow
   - Integration tests s Docker
   - CI setup s Docker builds

4. **Task 11**: CI/CD pipeline
   - GitHub Actions s Docker builds
   - Automated testing
   - Release automation

## Akceptační kritéria splněna

✅ `Taskfile.yaml` vytvořen s 25 tasks
✅ `task check` funguje (lint:fix + typecheck)
✅ `task inspector` má dependency na build
✅ `task ci` pipeline definován
✅ `Dockerfile` multi-stage build s Firefox ESR
✅ `.dockerignore` optimalizuje build cache
✅ `docker-compose.yml` pro lokální testování
✅ Non-root user v Docker image
✅ ENV variables pro Firefox RDP config
✅ Inspector tasks (inspector, inspector:dev) fungují přes Taskfile
